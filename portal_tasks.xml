<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="portal_timesheet_embed" name="Portal Timesheet Embed">

        <t t-set="pending_new"
           t-value="pending_requests.filtered(lambda r: req_disp_map.get(r.id, {}).get('type') == 'new')"/>
        <t t-set="pending_corr"
           t-value="pending_requests.filtered(lambda r: req_disp_map.get(r.id, {}).get('type') == 'correction')"/>

        <style>
            .ts-btn-big { padding:.55rem .95rem !important; font-size:.85rem !important; font-weight:600; }
            /* Hilangkan styling khusus running badge di list; kita tidak pakai lagi */
            .badge-running { display:none; }
            /* Hindari double hover pada baris pembungkus inner table dan header group */
            .table.table-hover tbody tr.no-hover:hover,
            .table-group-header-row:hover { background-color: transparent !important; }
        </style>

        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <button type="button" class="btn btn-sm btn-outline-primary ts-toggle-all" data-action="expand">Expand All
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary ts-toggle-all" data-action="collapse">Collapse
                All
            </button>
        </div>

        <t t-set="section_defs" t-value="[{'key':'pending_new','title':'Pending New Entries','records': pending_new},
 {'key':'pending_corr','title':'Pending Corrections','records': pending_corr},
 {'key':'rejected','title':'Rejected (Last 20)','records': rejected_requests},
 {'key':'approved','title':'Approved (Last 20)','records': approved_requests},
]"/>

        <t t-foreach="section_defs" t-as="sec">
            <t t-set="recset" t-value="sec.get('records')"/>
            <div class="ts-section mb-3" t-att-data-sec="sec.get('key')">
                <div class="d-flex align-items-center justify-content-between ts-sec-header px-3 py-2 rounded border"
                     t-att-data-target="'#sec_body_'+sec.get('key')" data-collapsed="true"
                     role="button" t-att-aria-controls="'sec_body_'+sec.get('key')" aria-expanded="false"
                     style="background:#f8f9fa; border-left:5px solid #d9dee3; cursor:pointer;">
                    <div class="d-flex align-items-center flex-wrap">
                        <strong class="me-2" t-esc="sec.get('title')"/>
                        <span class="badge count-badge ms-1" t-esc="(recset and len(recset)) or 0"/>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small toggle-label">Show</span>
                        <i class="fa fa-chevron-down rotate-icon" style="transition:.25s;"></i>
                    </div>
                </div>
                <div class="collapse ts-sec-body" t-att-id="'sec_body_'+sec.get('key')">
                    <t t-if="recset">
                        <div class="row g-2 mt-2">
                            <t t-foreach="recset" t-as="rq">
                                <t t-set="rinfo" t-value="req_disp_map.get(rq.id) or {}"/>
                                <t t-set="emp_name"
                                   t-value="(rq.z_employee_id and rq.z_employee_id.name) or (rq.z_timesheet_id and rq.z_timesheet_id.employee_id and rq.z_timesheet_id.employee_id.name) or rq.create_uid.name"/>
                                <div class="col-12">
                                    <div class="card shadow-sm border-0" style="border-left:4px solid #e1e5e9;"
                                         t-att-data-req-id="rq.id">
                                        <div class="card-body p-3 d-flex justify-content-between">
                                            <div class="me-3">
                                                <div class="d-flex align-items-center mb-1 flex-wrap">
                                                    <strong class="me-2" t-esc="emp_name or '-'"/>
                                                    <t t-if="rinfo.get('type')=='new'">
                                                        <span class="badge bg-primary">New</span>
                                                    </t>
                                                    <t t-elif="rinfo.get('type')=='correction'">
                                                        <span class="badge bg-purple" style="background:#6f42c1;">
                                                            Correction
                                                        </span>
                                                    </t>
                                                    <t t-if="sec.get('key').startswith('pending')">
                                                        <span class="badge bg-warning text-dark ms-2">Waiting</span>
                                                    </t>
                                                    <t t-elif="sec.get('key')=='approved'">
                                                        <span class="badge bg-success ms-2">Approved</span>
                                                    </t>
                                                    <t t-elif="sec.get('key')=='rejected'">
                                                        <span class="badge bg-danger ms-2">Rejected</span>
                                                    </t>
                                                </div>
                                                <div class="small mb-1">
                                                    <t t-if="rinfo.get('type')=='correction'">
                                                        <strong class="text-muted">Original:</strong>
                                                        <t t-esc="rinfo.get('ori_start') or '-'"/>
                                                        →
                                                        <t t-esc="rinfo.get('ori_end') or '-'"/>
                                                        <br/>
                                                    </t>
                                                    <strong class="text-primary">
                                                        <t t-if="sec.get('key')=='approved'">Final:</t>
                                                        <t t-elif="sec.get('key')=='rejected'">Actual:</t>
                                                        <t t-else="">Actual:</t>
                                                    </strong>
                                                    <t t-esc="rinfo.get('new_start') or '-'"/>
                                                    →
                                                    <t t-esc="rinfo.get('new_end') or '-'"/>
                                                    (<t t-esc="rinfo.get('hours') or 0"/>h)
                                                </div>
                                                <div class="text-muted small" t-esc="rinfo.get('desc') or ''"/>
                                                <t t-if="sec.get('key')=='rejected' and (rinfo.get('reject_reason_desc') or rinfo.get('reject_reason'))">
                                                    <div class="alert alert-danger py-1 px-2 mt-2 mb-0">
                                                        <i class="fa fa-exclamation-triangle me-1"></i>
                                                        <strong>Rejected:</strong>
                                                        <span t-esc="rinfo.get('reject_reason_desc') or rinfo.get('reject_reason')"/>
                                                    </div>
                                                </t>

                                                <div class="mt-1 d-flex flex-wrap gap-1">
                                                    <span class="badge bg-light text-dark">
                                                        <t t-esc="task.project_id.label_tasks or task.project_id.name or ''"/>
                                                    </span>
                                                    <span class="badge bg-light text-dark">
                                                        <t t-esc="task.name"/>
                                                    </span>
                                                    <t t-if="task.z_master_task_id">
                                                        <span class="badge bg-light text-dark">
                                                            <t t-esc="task.z_master_task_id.z_name"/>
                                                        </span>
                                                    </t>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <t t-if="(can_approve_timesheet_for_task or can_approve_timesheet) and sec.get('key').startswith('pending')">
                                                    <div class="request-action-group d-flex gap-2">
                                                        <button type="button"
                                                                class="btn btn-success ts-btn-big btn-req-approve"
                                                                t-att-data-id="rq.id"
                                                                t-att-data-type="rinfo.get('type')">
                                                            <i class="fa fa-check me-1"></i>Approve
                                                        </button>
                                                        <button type="button"
                                                                class="btn btn-outline-danger ts-btn-big btn-req-reject"
                                                                t-att-data-id="rq.id"
                                                                t-att-data-type="rinfo.get('type')">
                                                            <i class="fa fa-times me-1"></i>Reject
                                                        </button>
                                                    </div>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </t>
                    <t t-else="">
                        <div class="alert alert-light py-2 mt-2 mb-0">
                            <t t-if="sec.get('key')=='pending_new'">No pending new requests.</t>
                            <t t-elif="sec.get('key')=='pending_corr'">No pending corrections.</t>
                            <t t-elif="sec.get('key')=='approved'">No approved history yet.</t>
                            <t t-elif="sec.get('key')=='rejected'">No rejected history yet.</t>
                        </div>
                    </t>
                </div>
            </div>
        </t>

        <h5 class="mt-4 mb-2">Timesheet Entries</h5>
        <div class="d-none d-md-block">
            <t t-if="timesheets_show or timesheets">
                <div class="table-responsive">
                    <table class="table table-striped timesheet-table">
                        <thead>
                            <tr>
                                <th>Start</th>
                                <th>End</th>
                                <th>Employee</th>
                                <th>Description</th>
                                <th>Time Spent</th>
                                <th>Status</th>
                                <th style="width:80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="timesheet_table_body">
                            <t t-foreach="timesheets_show or timesheets or []" t-as="ts">
                                <tr>
                                    <td>
                                        <t t-if="zeiten_map.get(ts.id)">
                                            <t t-esc="zeiten_map.get(ts.id).get('start_wib')"/>
                                        </t>
                                    </td>
                                    <td>
                                        <t t-if="zeiten_map.get(ts.id) and zeiten_map.get(ts.id).get('end_wib')">
                                            <t t-esc="zeiten_map.get(ts.id).get('end_wib')"/>
                                        </t>
                                        <t t-else="">
                                            <span>Running</span>
                                        </t>
                                    </td>
                                    <td>
                                        <span t-field="ts.employee_id.name"/>
                                    </td>
                                    <td>
                                        <span t-field="ts.name"/>
                                    </td>
                                    <td>
                                        <t t-set="mins" t-value="int(round((ts.unit_amount or 0)*60))"/>
                                        <t t-set="hh" t-value="mins//60"/>
                                        <t t-set="mm" t-value="mins%60"/>
                                        <span>
                                            <t t-esc="'%02d:%02d' % (hh, mm)"/>
                                            <small class="text-muted d-block">(
                                                <t t-esc="round(ts.unit_amount or 0,2)"/>
                                                h)
                                            </small>
                                        </span>
                                    </td>
                                    <td>
                                        <t t-esc="ts.z_state or ''"/>
                                    </td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary edit-timesheet-btn"
                                                t-att-data-task-id="task.id"
                                                t-att-data-timesheet-id="ts.id">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <form t-attf-action="/portal/task/#{task.id}/timesheet/delete/#{ts.id}"
                                              method="post" class="d-inline-block ms-1"
                                              t-if="can_approve_timesheet_for_task or can_approve_timesheet">
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Delete?')">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
                <t t-if="ts_pager and ts_pager['total_pages'] &gt; 1">
                    <div class="load-more-wrapper">
                        <button class="btn btn-outline-primary btn-sm btn-load-more-timesheets"
                                t-att-data-task-id="task.id"
                                data-next-page="2">Load More
                        </button>
                    </div>
                </t>
            </t>
            <t t-if="not (timesheets_show or timesheets)">
                <div class="alert alert-warning" role="alert">No timesheet entries.</div>
            </t>
        </div>

        <div class="d-md-none mt-4">
            <t t-if="timesheets_show or timesheets">
                <div class="row g-3" id="timesheet_card_container">
                    <t t-foreach="timesheets_show or timesheets" t-as="ts">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">
                                            <span t-field="ts.employee_id.name"/>
                                        </h6>
                                        <span t-esc="ts.z_state or ''"/>
                                    </div>
                                    <div class="row g-2 text-sm">
                                        <div class="col-6">
                                            <strong>Start:</strong>
                                            <br/>
                                            <t t-if="zeiten_map.get(ts.id)">
                                                <span t-esc="zeiten_map.get(ts.id).get('start_wib')"/>
                                            </t>
                                        </div>
                                        <div class="col-6">
                                            <strong>End:</strong>
                                            <br/>
                                            <t t-if="zeiten_map.get(ts.id) and zeiten_map.get(ts.id).get('end_wib')">
                                                <span t-esc="zeiten_map.get(ts.id).get('end_wib')"/>
                                            </t>
                                            <t t-else="">
                                                <span class="text-muted">Running...</span>
                                            </t>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <strong>Duration:</strong>
                                        <t t-set="mins" t-value="int(round((ts.unit_amount or 0)*60))"/>
                                        <t t-set="hh" t-value="mins//60"/>
                                        <t t-set="mm" t-value="mins%60"/>
                                        <span>
                                            <t t-esc="'%02d:%02d' % (hh, mm)"/>
                                            <small class="text-muted d-block">(
                                                <t t-esc="round(ts.unit_amount or 0,2)"/>
                                                h)
                                            </small>
                                        </span>
                                    </div>
                                    <t t-if="ts.name">
                                        <div class="mt-2">
                                            <strong>Description:</strong>
                                            <br/>
                                            <span t-field="ts.name" class="text-muted"/>
                                        </div>
                                    </t>
                                    <div class="mt-3 d-flex gap-2">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary edit-timesheet-btn"
                                                t-att-data-task-id="task.id"
                                                t-att-data-timesheet-id="ts.id">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <form t-if="can_approve_timesheet_for_task or can_approve_timesheet"
                                              t-attf-action="/portal/task/#{task.id}/timesheet/delete/#{ts.id}"
                                              method="post" class="d-inline-block">
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Delete?')">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
                <t t-if="ts_pager and ts_pager['total_pages'] &gt; 1">
                    <div class="load-more-wrapper">
                        <button class="btn btn-outline-primary btn-sm btn-load-more-timesheets"
                                t-att-data-task-id="task.id"
                                data-next-page="2">
                            Load More
                        </button>
                    </div>
                </t>
            </t>
            <t t-if="not (timesheets_show or timesheets)">
                <div class="alert alert-warning" role="alert">
                    <i class="fa fa-info-circle me-2"></i>No timesheet entries yet.
                </div>
            </t>
        </div>
    </template>

    <template id="portal_task_page" name="Portal Tasks">
        <t t-call="portal.portal_layout">
            <!-- ================== CDN / LIBS ================== -->
            <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"/>
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"/>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"/>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
            <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

            <script type="text/javascript">
                <![CDATA[
                    document.addEventListener('DOMContentLoaded', function(){
                        setTimeout(function(){
                            document.querySelectorAll('.alert.portal-auto-hide').forEach(function(a){
                                a.style.transition='opacity .4s';
                                a.style.opacity='0';
                                setTimeout(()=>a.remove(),450);
                            });
                        },4000);
                    });
                ]]>
            </script>
            <script type="text/javascript">
                <![CDATA[
                    document.addEventListener('DOMContentLoaded', function(){
                      const params = new URLSearchParams(window.location.search);
                      const err = params.get('error');
                      if(err){
                        // normalize html entities
                        const msg = err.replace(/&gt;/g,'>').replace(/&lt;/g,'<');
                        alert(msg);
                      }
                    });
                ]]>
            </script>
            <script type="text/javascript">
                <![CDATA[
                    document.addEventListener('DOMContentLoaded', function(){
                        // Toggle group rows (non-nested rows)
                        document.querySelectorAll('.group-toggle-btn').forEach(btn=>{
                            btn.addEventListener('click', function(e){
                                e.stopPropagation();
                                const gid = this.dataset.groupId;
                                const rows = document.querySelectorAll('tr.group-item-row[data-group="'+gid+'"]');
                                const icon = this.querySelector('i');
                                if(!rows.length) return;
                                const currentlyHidden = rows[0].style.display === 'none' || !rows[0].style.display;
                                rows.forEach(r => { r.style.display = currentlyHidden ? 'table-row' : 'none'; });
                                if(icon){
                                    if(currentlyHidden){
                                        icon.classList.remove('fa-caret-right');
                                        icon.classList.add('fa-caret-down');
                                    }else{
                                        icon.classList.remove('fa-caret-down');
                                        icon.classList.add('fa-caret-right');
                                    }
                                }
                            });
                        });
                    });
                    ]]>
            </script>


            <!-- ================== MAIN SCRIPT ================== -->
            <script type="text/javascript">
                <![CDATA[
                    $(document).ready(function(){

                      /* ========== Select2 Init ========== */
                      $('.js-example-basic-single').select2({placeholder:"Select an option",allowClear:true,width:'100%'});
                      $('.js-example-basic-multiple').select2({placeholder:"Select multiple options",allowClear:true,width:'100%'});

                      function setupDynamicSelect2(selector){
                        const el=$(selector);
                        if(!el.length){return;}
                        el.select2({
                          placeholder:"Select an option",
                          allowClear:true,
                          width:'100%',
                          templateResult:function(data){
                            try{
                              var selectedIds=el.val()||[];
                              var dataId=(data && data.id!=null)?data.id.toString():null;
                              if(dataId && selectedIds.indexOf(dataId)!==-1){return null;}
                              return data && (data.text || (data.element && $(data.element).text())) || '';
                            }catch(err){
                              return data && (data.text || '') || '';
                            }
                          }
                        });
                      }
                      setupDynamicSelect2('select[name="z_head_assignes_ids"]');
                      setupDynamicSelect2('select[name="z_member_assignes_ids"]');
                      setupDynamicSelect2('select[name="tag_ids"]');

                      /* ========== Helpers ========== */
                      // Tampilkan Customer hanya untuk NON-others (delivery/maintenance)
                      function toggleCustomerVisibility(isOthers){
                        const show = !isOthers;

                        // NEW form
                        const $custNew = $('#customer_display');
                        if($custNew.length){
                          const $blk = $custNew.closest('.mb-3');
                          show ? $blk.show() : $blk.hide();
                        }

                        // EDIT form (berdasarkan label “Customer”)
                        $('form#edit_task_form .mb-3').filter(function(){
                          const $lbl=$(this).find('> label, .form-label').first();
                          return $lbl.length && /customer/i.test($lbl.text().trim());
                        }).each(function(){
                          show ? $(this).show() : $(this).hide();
                        });
                      }

                      // Hanya tampilkan maintenance-only saat project = maintenance
                      function applyProjectTypeHiding(info){
                        const isMaintenance = (info && info.z_type_in_project === 'maintenance');
                        const maintenanceOnlySelectors = [
                          'select[name="z_technology_id"]',
                          'select[name="z_severity_id"]',
                          'select[name="z_regional_id"]'
                        ];
                        maintenanceOnlySelectors.forEach(sel=>{
                          const $blk = $(sel).closest('.mb-3');
                          if(!$blk.length) return;
                          if(isMaintenance){ $blk.show(); } else { $blk.hide(); }
                        });
                      }

                      // Others Mode: atur field umum; TIDAK menyentuh maintenance-only; TIDAK menyembunyikan master-select; TIDAK memaksa free-text
                        function toggleOthersMode(){
                          const dropdownVal = ($('#z_type_non_project_select').val() || '');
                          const isOthers = (dropdownVal === 'others') || !!window._isOthersProject;

                          const $plannedStart = $('input[name="z_planned_start_date"]');
                          const $plannedEnd   = $('input[name="z_planned_end_date"]');

                          // Daftar selector kontrol (bukan wrapper .mb-3)
                          const ctrls = [
                            'select[name="z_head_assignes_ids"]',
                            'select[name="z_member_assignes_ids"]',
                            'select[name="tag_ids"]',
                            'input[name="z_planned_start_date"]',
                            'input[name="z_planned_end_date"]',
                            'input[name="z_actual_start_date"]',
                            'input[name="z_actual_end_date"]',
                            'input[name="z_bobot_entry"]',
                            'input[name="z_mandays_budget_entry"]',
                            'input[name="z_actual_budget_mandays"]',
                            'input[name="z_progress_project"]',
                            'input[name="z_progress_project_entry"]',
                            'input[name="z_quality_entry"]'
                          ];
                          ctrls.forEach(sel=>{
                            const $el = $(sel);
                            const $blk = $el.closest('.mb-3');
                            if(!$blk.length) return;
                            if(isOthers){
                              $blk.hide();
                              $el.prop('disabled', true);            // penting: cegah terkirim
                              if($el.hasClass('select2-hidden-accessible')) $el.trigger('change.select2');
                            }else{
                              $blk.show();
                              $el.prop('disabled', false);           // aktifkan kembali
                              if($el.hasClass('select2-hidden-accessible')) $el.trigger('change.select2');
                            }
                          });

                          // Required untuk planned dates hanya non-others
                          if(isOthers){
                            $plannedStart.removeAttr('required');
                            $plannedEnd.removeAttr('required');
                          }else{
                            if($plannedStart.data('required')) $plannedStart.attr('required', true);
                            if($plannedEnd.data('required'))   $plannedEnd.attr('required', true);
                          }

                          toggleCustomerVisibility(isOthers);
                        }

                      // Toggle Master Task (select vs free-text)
                      function toggleMasterCreate(scope){
                        const $scope = scope ? $(scope) : $(document);

                        const $chkNew  = $scope.find('#z_master_task_self_create_ok');
                        const $selBlkN = $scope.find('.master-select-block');
                        const $freeBlkN= $scope.find('.master-freetext-block');
                        if($chkNew.length){
                          const apply = ()=>{
                            const on = $chkNew.is(':checked');
                            if(on){
                              $selBlkN.hide();
                              $freeBlkN.show();
                              $freeBlkN.find('input[name="z_master_task_free_text"]').attr('required', true);
                              $selBlkN.find('select[name="z_master_task_id"]').removeAttr('required');
                            }else{
                              $selBlkN.show();
                              $freeBlkN.hide();
                              $freeBlkN.find('input[name="z_master_task_free_text"]').removeAttr('required');
                            }
                          };
                          apply();
                          $chkNew.off('change._mtoggle').on('change._mtoggle', apply);
                        }

                        const $chkEdit  = $scope.find('#z_master_task_self_create_ok_edit');
                        const $selBlkE = $scope.find('.master-select-block-edit');
                        const $freeBlkE= $scope.find('.master-freetext-block-edit');
                        if($chkEdit.length){
                          const applyE = ()=>{
                            const on = $chkEdit.is(':checked');
                            if(on){
                              $selBlkE.hide();
                              $freeBlkE.show();
                              $freeBlkE.find('input[name="z_master_task_free_text"]').attr('required', true);
                              $selBlkE.find('select[name="z_master_task_id"]').removeAttr('required');
                            }else{
                              $selBlkE.show();
                              $freeBlkE.hide();
                              $freeBlkE.find('input[name="z_master_task_free_text"]').removeAttr('required');
                            }
                          };
                          applyE();
                          $chkEdit.off('change._mtoggle').on('change._mtoggle', applyE);
                        }
                      }

                      // Warning data belum disimpan
                      function attachUnsavedWarning(formSelector){
                        const $f = $(formSelector);
                        if(!$f.length) return;
                        let dirty = false;
                        $f.on('change input', 'input,select,textarea', ()=>{ dirty = true; });
                        $f.on('submit', ()=>{ dirty = false; window._ignoreLeaveWarn = true; });
                        window.addEventListener('beforeunload', function(e){
                          if(window._ignoreLeaveWarn) return;
                          if(dirty){
                            e.preventDefault();
                            e.returnValue = 'Perubahan belum disimpan. Yakin ingin keluar?';
                            return 'Perubahan belum disimpan. Yakin ingin keluar?';
                          }
                        });
                        $(document).on('click', 'a,button[type="button"]', function(e){
                          const href = $(this).attr('href');
                          const isSubmitBtn = $(this).attr('form') || $(this).attr('type') === 'submit';
                          if(href && !isSubmitBtn && dirty){
                            const ok = confirm('Data belum disimpan, yakin ingin keluar?');
                            if(!ok){ e.preventDefault(); }
                          }
                        });
                      }

                      // Populate Assignees dari Project Teams (AJAX)
                      function repopulateTeamSelects(team){
                        const $head = $('select[name="z_head_assignes_ids"]');
                        const $member = $('select[name="z_member_assignes_ids"]');

                        const selHead = ($head.val() || []).map(String);
                        const selMember = ($member.val() || []).map(String);

                        function fill($el, selected){
                          const hadSelect2 = $el.hasClass('select2-hidden-accessible');
                          if(hadSelect2){ $el.off('select2:select'); } // prevent duplicate handlers if any
                          $el.empty();
                          // Build options
                          const frag = document.createDocumentFragment();
                          team.forEach(emp=>{
                            const opt = new Option(emp.name, String(emp.id), false, selected.includes(String(emp.id)));
                            frag.appendChild(opt);
                          });
                          $el.append(frag);
                          if(hadSelect2){
                            $el.trigger('change.select2'); // refresh select2 rendering
                          }else{
                            $el.trigger('change');
                          }
                        }

                        fill($head, selHead);
                        fill($member, selMember);
                      }

                      function fetchProjectTeam(projectId){
                        if(!projectId){
                          repopulateTeamSelects([]);
                          return;
                        }
                        $.getJSON('/portal/project/'+projectId+'/team', function(resp){
                          if(resp && resp.success){
                            repopulateTeamSelects(resp.data || []);
                          }else{
                            repopulateTeamSelects([]);
                          }
                        }).fail(function(){
                          repopulateTeamSelects([]);
                        });
                      }

                      // Apply project info + detect Others via project + fetch team
                      function applyProjectInfo(info){
                        const $projName = $('input[name="z_project_name"]');
                        const $customerDisplay = $('#customer_display');
                        const $partnerHidden = $('input[name="partner_id"]');

                        if(!info || info.error){
                          $projName.val('');
                          $customerDisplay.val('');
                          $partnerHidden.val('');
                          window._isOthersProject = false;
                          applyProjectTypeHiding(null);
                          repopulateTeamSelects([]);
                        }else{
                          $projName.val(info.label_tasks || info.name || '');
                          $customerDisplay.val(info.partner_name || '');
                          $partnerHidden.val(info.partner_id || '');
                          window._isOthersProject = (info.z_group_type_project === 'non_project' && info.z_type_non_project === 'others');
                          // Sinkronkan dropdown Others jika project memang Others
                          const $sel = $('#z_type_non_project_select');
                          if($sel.length){
                            const target = window._isOthersProject ? 'others' : '';
                            if(($sel.val()||'') !== target){
                              $sel.val(target).trigger('change');
                            }
                          }
                          applyProjectTypeHiding(info);
                          fetchProjectTeam(info.id);
                        }
                        toggleOthersMode();
                      }

                      function fetchAndApplyProject(projectId){
                        if(!projectId){ applyProjectInfo(null); return; }
                        $.getJSON('/portal/project/'+projectId+'/info', function(info){
                          applyProjectInfo(info);
                        }).fail(function(){ applyProjectInfo(null); });
                      }

                      /* ========== Init bindings ========== */
                      // Customer kini dikontrol via toggleOthersMode() -> toggleCustomerVisibility()
                      applyProjectTypeHiding(null);          // Default: sembunyikan maintenance-only sampai project terdeteksi

                      $(document).on('change','#z_type_non_project_select', toggleOthersMode);
                      toggleOthersMode();

                      toggleMasterCreate(document);
                      attachUnsavedWarning('#new_task_form');
                      attachUnsavedWarning('#edit_task_form');

                      $(document).on('change','select[name="project_id"]', function(){
                        const pid = $(this).val();
                        fetchAndApplyProject(pid);
                        fetchProjectTeam(pid); // jaga-jaga kalau info endpoint delay
                      });

                      // Initial apply project + team
                      let ctxProjectId = $('input[name="project_id"][type="hidden"]').val()
                                       || $('select[name="project_id"]').val();
                      if(ctxProjectId){
                        fetchAndApplyProject(ctxProjectId);
                        fetchProjectTeam(ctxProjectId);
                      } else {
                        // Pastikan state awal Customer sesuai Others dropdown kosong (anggap non-others)
                        toggleOthersMode();
                      }

                      // Handler New Subtask: bawa master parent yang sedang dipilih (kalau ada) sebagai hint
                      $(document).on('click', '.btn-new-subtask', function(e){
                        e.preventDefault();
                        const parentId = $(this).data('parent-id');
                        let hint = '';
                        const $sel = $('.master-select-block-edit select[name="z_master_task_id"]');
                        if($sel.length && $sel.is(':visible')){ hint = $sel.val() || ''; }
                        const url = '/portal/tasks?mode=new&parent_id=' + parentId + (hint ? '&parent_master_hint=' + encodeURIComponent(hint) : '');
                        window.location.href = url;
                      });


                      function initDateTimePickers24(scope){
                      const $s = scope ? $(scope) : $(document);
                      const opts = { enableTime:true, time_24hr:true, dateFormat:"Y-m-d H:i", allowInput:true };
                      $s.find('input.dt-24').each(function(){
                        if (this._flatpickr) return;
                        flatpickr(this, opts);
                      });
                    }
                    initDateTimePickers24(document);

                    $(document).on('shown.bs.modal', '#requestTimesheetModal,#timesheetModal', function(){
                      initDateTimePickers24(this);
                    });


                    $(document).on('click', '.btn-calculate-bobot', function(){
                      const taskId = $(this).data('task-id');
                      const csrf = $('input[name="csrf_token"]').val() || '';
                      const $btn = $(this).prop('disabled', true).addClass('disabled');
                      $.post(`/portal/task/${taskId}/calculate-bobot`, { csrf_token: csrf }, function(r){
                        if(r && r.success){
                          alert('Perhitungan bobot berhasil.');
                          location.reload();
                        }else{
                          alert(r && r.error ? r.error : 'Perhitungan bobot gagal.');
                        }
                      }, 'json').always(function(){
                        $btn.prop('disabled', false).removeClass('disabled');
                      });
                    });

                    // Live hint untuk Request
                    function calcHoursDiff(startStr,endStr){
                      if(!startStr||!endStr) return 0;
                      try{
                        const s=new Date(startStr.replace('T',' '));
                        const e=new Date(endStr.replace('T',' '));
                        const diffMs=e.getTime()-s.getTime();
                        if(isNaN(diffMs)||diffMs<=0) return 0;
                        return diffMs/3600000;
                      }catch(e){return 0;}
                    }
                    function updateRequestHoursHint(){
                      const h = calcHoursDiff($('input[name="start_date"]').val(), $('input[name="end_date"]').val());
                      $('#request_hours_hint').text(h ? `Duration: ${h.toFixed(2)} h` : '');
                    }
                    $(document).on('change', 'input[name="start_date"], input[name="end_date"]', updateRequestHoursHint);
                    $('#requestTimesheetModal').on('shown.bs.modal', updateRequestHoursHint);

                    // Pastikan hidden hours untuk Correction terisi
                    function updateCorrectionHours(){
                      const h = calcHoursDiff($('#timesheet_start_date').val(), $('#timesheet_end_date').val());
                      if(!isNaN(h) && isFinite(h)){
                        $('#timesheet_hours').val(h.toFixed(2));
                      }
                    }
                    $('#timesheet_start_date,#timesheet_end_date').on('change', updateCorrectionHours);
                    $('#timesheetModal').on('shown.bs.modal', updateCorrectionHours);

                      /* ========== TIME FORMAT PATCH (tetap) ========== */
                    const ENABLE_TIME_SHIFT = true;
                    function toLocalFromUtc(utcIso){
                      if(!utcIso) return '';
                      try{
                        let iso = utcIso.trim().replace(' ','T');
                        if(!/[zZ]|[+\-]\d{2}:?\d{2}$/.test(iso)){ iso += 'Z'; } // pastikan sebagai UTC
                        const d = new Date(iso);
                        if(isNaN(d.getTime())) return utcIso;
                        // Format 24 jam, ikut timezone browser (WIB/WITA/WIT tergantung device)
                        const fmt = new Intl.DateTimeFormat(undefined, {
                          year:'2-digit', month:'2-digit', day:'2-digit',
                          hour:'2-digit', minute:'2-digit', hour12:false
                        });
                        // Hasil default locale punya separator lokal; kita normalisasi dd/mm/yy HH:MM
                        const parts = fmt.formatToParts(d).reduce((acc,p)=>{acc[p.type]=p.value;return acc;}, {});
                        const dd = parts.day || '';
                        const mm = parts.month || '';
                        const yy = parts.year || '';
                        const HH = parts.hour || '';
                        const MM = parts.minute || '';
                        return `${dd}/${mm}/20${yy} ${HH}:${MM}`;
                      }catch(e){ return utcIso; }
                    }
                    function reformatAllDateSpans(scope){
                      if(!ENABLE_TIME_SHIFT) return;
                      const $scope = scope ? $(scope) : $(document);
                      $scope.find('.timesheet-datetime').each(function(){
                        const $el=$(this);
                        if($el.attr('data-shifted')==='1') return;
                        if($el.data('origin')!=='utc') return;
                        const raw=$el.attr('data-utc');
                        if(raw){
                          $el.text(toLocalFromUtc(raw));
                          $el.attr('data-shifted','1');
                        }
                      });
                    }
                    reformatAllDateSpans();


                        function applyRoleFieldLocks(){
                            const $form = $('#edit_task_form');
                            const isHead = ($form.data('is-head') === 1 || $form.data('is-head') === '1')|| ($form.data('is-head-engineer') === 1 || $form.data('is-head-engineer') === '1'); // fallback
                            const isEngineer = ($form.data('is-engineer') === 1 || $form.data('is-engineer') === '1');
                            const isPM = ($form.data('is-pm') === 1 || $form.data('is-pm') === '1');
                            const isAdmin = ($form.data('is-admin') === 1 || $form.data('is-admin') === '1');
                            const state   = String($form.data('task-state')||'');
                             const isROAll = ($form.data('form-readonly-all')===1 || $form.data('form-readonly-all')==='1');

                          function disableAll(){
                            $form.find('input,select,textarea,button[type="submit"]').each(function(){
                              const $el = $(this);
                              if(this.type==='hidden') return;
                              if($el.closest('.action-toolbar').length) return; // tombol action tetap aktif
                              if($el.is('#btnTimeStart,#btnTimeStop,#btnTimePause,#btnRequestTimesheet')) return;
                              $el.prop('disabled', true).attr('readonly', true);
                              if($el.hasClass('select2-hidden-accessible')) $el.trigger('change.select2');
                            });
                            $('.btn-sync-bobot').prop('disabled', true).addClass('disabled').hide();
                            if(isEngineer){ $('.btn-new-subtask').hide(); }
                          }
                          function enableSelector(sel){
                            $form.find(sel).each(function(){
                              $(this).prop('disabled', false).removeAttr('readonly');
                              if($(this).hasClass('select2-hidden-accessible')) $(this).trigger('change.select2');
                            });
                          }

                          // Readonly-all atau Engineer => kunci semua (kecuali toolbar/timer)
                          if(isEngineer || isROAll){
                            disableAll();
                            return;
                          }

                          // Head (tanpa PM/Admin): boleh edit Member + Description saat new/in_progress
                          if(isHead && !(isPM || isAdmin)){
                            disableAll();
                            if(!['approved1','approved2','done'].includes(state)){
                              enableSelector('select[name="z_member_assignes_ids"]');
                              enableSelector('textarea[name="description"]');
                              $('button[type="submit"][form="edit_task_form"]').prop('disabled', false).removeAttr('readonly');
                            }
                            return;
                          }

                          // PM/Admin: bebas
                        }
                        applyRoleFieldLocks();


                      $(document).on('click', '.btn-calculate-bobot', function(){
                        const taskId = $(this).data('task-id');
                        const csrf = $('input[name="csrf_token"]').val() || '';
                        const $btn = $(this).prop('disabled', true).addClass('disabled');
                        $.post(`/portal/task/${taskId}/calculate-bobot`, { csrf_token: csrf }, function(r){
                          if(r && r.success){
                            alert('Perhitungan bobot berhasil.');
                            location.reload();
                          }else{
                            alert(r && r.error ? r.error : 'Perhitungan bobot gagal.');
                          }
                        }, 'json').always(function(){
                          $btn.prop('disabled', false).removeClass('disabled');
                        });
                      });


                      /* ========== Load More (tetap) ========== */
                      $(document).on('click', '.btn-load-more-timesheets', function(){
                        const $btn = $(this);
                        const nextPage = parseInt($btn.attr('data-next-page')) || 2;
                        const taskId = $btn.data('task-id');
                        $btn.prop('disabled', true).text('Loading...');
                        $.getJSON(`/portal/task/${taskId}/timesheets/json?page=${nextPage}`, function(resp){
                          if(resp && resp.success){
                            if(resp.items_html){ $('#timesheet_table_body').append(resp.items_html); }
                            if(resp.cards_html){ $('#timesheet_card_container').append(resp.cards_html); }
                            reformatAllDateSpans();
                            if(resp.has_more){
                              $btn.attr('data-next-page', nextPage+1).prop('disabled', false).text('Load More');
                            } else {
                              $btn.remove();
                            }
                          } else {
                            $btn.prop('disabled', false).text('Load More');
                            alert(resp.error || 'Failed to load more');
                          }
                        }).fail(function(){
                          $btn.prop('disabled', false).text('Load More');
                          alert('Failed to load more');
                        });
                      });

                      $(document).on('click', '.btn-load-more-invoice-plans', function(){
                        const $btn = $(this);
                        const nextPage = parseInt($btn.attr('data-next-page')) || 2;
                        const taskId = $btn.data('task-id');
                        $btn.prop('disabled', true).text('Loading...');
                        $.getJSON(`/portal/task/${taskId}/invoice-plans/json?page=${nextPage}`, function(resp){
                          if(resp && resp.success){
                            if(resp.items_html){ $('#invoice_plan_table_body').append(resp.items_html); }
                            if(resp.cards_html){ $('#invoice_plan_card_container').append(resp.cards_html); }
                            if(resp.has_more){
                              $btn.attr('data-next-page', nextPage+1).prop('disabled', false).text('Load More');
                            } else {
                              $btn.remove();
                            }
                          } else {
                            $btn.prop('disabled', false).text('Load More');
                            alert(resp.error || 'Failed to load more');
                          }
                        }).fail(function(){
                          $btn.prop('disabled', false).text('Load More');
                          alert('Failed to load more');
                        });
                      });

                      /* ========== Timer & Timesheets action (tetap) ========== */
                      const csrf_token=$('input[name="csrf_token"]').val()||'';
                      const $timerBadge=$('#runningTimerBadge');
                      let timerInterval=null;
                      let isPaused=($timerBadge.data('paused')===true || $timerBadge.data('paused')==='true');

                      function pad(n){return n<10 ? '0'+n : n;}
                      function startUiTimer(startIsoStr){
                        if(!startIsoStr) return;
                        let start;
                        try{
                          let utcString=startIsoStr;
                          if(!utcString.includes('Z') && !utcString.includes('+')){utcString=startIsoStr+'Z';}
                          start=new Date(utcString);
                          if(isNaN(start.getTime())) return;
                        }catch(e){return;}
                        $timerBadge.removeClass('d-none');
                        if(timerInterval) clearInterval(timerInterval);
                        function updateTimer(){
                          if(isPaused) return;
                          const now=new Date();
                          let diffMs=now.getTime()-start.getTime();
                          let diffSeconds=Math.max(0,Math.floor(diffMs/1000));
                          const hours=Math.floor(diffSeconds/3600);
                          const minutes=Math.floor((diffSeconds%3600)/60);
                          const seconds=Math.floor(diffSeconds%60);
                          $timerBadge.text(pad(hours)+':'+pad(minutes)+':'+pad(seconds));
                        }
                        updateTimer();
                        timerInterval=setInterval(updateTimer,1000);
                      }
                      const startIso=$timerBadge.data('start');
                      if(startIso){startUiTimer(startIso);}

                      window._original_desc='';

                     // Sesuaikan populateTimesheetForm agar set nilai ke flatpickr
                    function populateTimesheetForm(ts){
                      const oriStart = ts.original_start_date || ts.start_date || '';
                      const oriEnd   = ts.original_end_date   || ts.end_date   || '';
                      $('#timesheet_original_start_date').val(oriStart);
                      $('#timesheet_original_end_date').val(oriEnd);
                      $('#timesheet_id').val(ts.id);

                      const sVal = (ts.start_date || '').replace('T',' ');
                      const eVal = (ts.end_date || '').replace('T',' ');

                      const sInp = document.getElementById('timesheet_start_date');
                      const eInp = document.getElementById('timesheet_end_date');
                      if(sInp && sInp._flatpickr){ sInp._flatpickr.setDate(sVal || null, true, 'Y-m-d H:i'); } else { $('#timesheet_start_date').val(sVal); }
                      if(eInp && eInp._flatpickr){ eInp._flatpickr.setDate(eVal || null, true, 'Y-m-d H:i'); } else { $('#timesheet_end_date').val(eVal); }

                      $('#timesheet_description').val(ts.description || '');
                      $('#timesheet_employee').val(ts.employee_id || '').trigger('change');
                      window._original_desc = ts.description || '';
                      if(ts.pending){
                        $('#pending_info').removeClass('d-none');
                        $('#timesheetModalLabel').text('Timesheet Correction (Pending Exists)');
                      } else {
                        $('#pending_info').addClass('d-none');
                        $('#timesheetModalLabel').text('Timesheet Correction');
                      }
                    }

                      function openTimesheetPopup(taskId, timesheetId){
                        if(!timesheetId){ alert('Pilih timesheet untuk dikoreksi'); return; }
                        $('#current_task_id').val(taskId);
                        $.get(`/portal/task/${taskId}/timesheet/${timesheetId}`, function(res){
                          if(res.error){ alert('Error: '+res.error); return; }
                          populateTimesheetForm(res);
                          $('#timesheetModal').modal('show');
                        }, 'json');
                      }
                      $(document).on('click','.edit-timesheet-btn',function(){
                        openTimesheetPopup($(this).data('task-id'), $(this).data('timesheet-id'));
                      });

                      $(document).off('click','#saveTimesheetBtn').on('click','#saveTimesheetBtn',function(){
                        const taskId=$('#current_task_id').val();
                        const tsId=$('#timesheet_id').val();
                        if(!tsId){ alert('Timesheet tidak valid.'); return; }


                        const fd = new FormData($('#timesheetForm')[0]);
                        fd.append('csrf_token', $('input[name="csrf_token"]').val()||'');

                        $.ajax({
                          url:`/portal/task/${taskId}/timesheet-correction`,
                          type:'POST',
                          data: fd,
                          processData:false,
                          contentType:false,
                          dataType:'json',
                          success: function(r){
                            if(r.success){
                              $('#timesheetModal').modal('hide');
                              alert('Correction submitted. Waiting for approval.');
                              location.reload();
                            } else {
                              alert('Error: ' + (r.error || 'Unknown'));
                            }
                          },
                          error: function(){ alert('Failed to submit correction'); }
                        });
                      });

                      $(document).on('click','#btnRequestTimesheet',function(){
                        $('#requestTimesheetModal').modal('show');
                      });

                      $(document).on('click','#saveRequestTimesheetBtn',function(){
                        var taskId=$(this).data('task-id');
                        var form=$('#requestTimesheetForm')[0];
                        var data=new FormData(form);
                        data.append('csrf_token',$('input[name="csrf_token"]').val()||'');
                        $.ajax({
                          url:'/portal/task/'+taskId+'/timesheet-request',
                          type:'POST',
                          data:data,
                          processData:false,
                          contentType:false,
                          dataType:'json',
                          success:function(r){
                            if(r.success){
                              $('#requestTimesheetModal').modal('hide');
                              alert('Timesheet request submitted. Waiting for approval.');
                              window.location.reload();
                            }else{
                              alert('Error: '+(r.error||'Unknown error'));
                            }
                          },
                          error:function(){alert('Failed to create timesheet request');}
                        });
                      });

                      function processTimesheetRequestAction($btn, action){
                        const id   = $btn.data('id');
                        const type = $btn.data('type');
                        if(!id || !type){ alert('Invalid request meta'); return; }
                        let base = (type === 'correction') ? '/portal/timesheet-correction/' : '/portal/timesheet-request/';
                        const url = base + id + '/' + action;
                        let payload = {csrf_token: $('input[name="csrf_token"]').val()||''};
                        if(action === 'reject'){
                          let reason = prompt('Masukkan alasan reject (wajib):');
                          if(reason === null) return; // cancel
                          reason = reason.trim();
                          if(!reason){ alert('Alasan reject wajib diisi.'); return; }
                          payload['reason'] = reason;
                        }
                        $.post(url, payload, function(r){
                          if(r.success){
                            alert('Success: '+action);
                            location.reload();
                          } else {
                            alert(r.error || 'Failed');
                          }
                        },'json').fail(function(){ alert('Server error'); });
                      }
                      $(document).off('click','.btn-req-approve').on('click','.btn-req-approve', function(){
                        processTimesheetRequestAction($(this), 'approve');
                      });
                      $(document).off('click','.btn-req-reject').on('click','.btn-req-reject', function(){
                        processTimesheetRequestAction($(this), 'reject');
                      });

                      function calcHoursDiff(startStr,endStr){
                        if(!startStr||!endStr) return 0;
                        try{
                          const s=new Date(startStr);
                          const e=new Date(endStr);
                          if(isNaN(s.getTime())||isNaN(e.getTime())) return 0;
                          const diffMs=e.getTime()-s.getTime();
                          if(diffMs<=0) return 0;
                          return diffMs/3600000;
                        }catch(e){return 0;}
                      }
                      $('#timesheet_start_date,#timesheet_end_date').on('change',function(){
                        const h=calcHoursDiff($('#timesheet_start_date').val(),$('#timesheet_end_date').val());
                        $('#timesheet_hours').val(h.toFixed(2));
                      });

                      $(document).on('click','#btnTimeStart',function(e){
                        e.preventDefault();
                        const taskId=$(this).data('task-id');
                        const action=isPaused ? 'resume':'start';
                        $.post('/portal/task/'+taskId+'/timer',{action:action,csrf_token:csrf_token},function(r){
                          if(r.success){
                            if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
                            startUiTimer(r.start_at);
                            isPaused=false;
                            $('#btnTimeStart').prop('disabled',true).find('span').text('Time Start');
                            $('#btnTimePause').prop('disabled',false).show();
                            $('#btnTimeStop').prop('disabled',false);
                            $timerBadge.removeClass('bg-warning').addClass('bg-primary').text('00:00:00').data('paused','false');
                            if(action==='start'){setTimeout(function(){location.reload();},2000);}
                          }else{
                            alert('Error: '+(r.error||'Unknown error'));
                          }
                        },'json').fail(function(xhr,status,error){
                          alert('Failed to start/resume timer: '+error);
                        });
                      });

                      $(document).on('click','#btnTimePause',function(e){
                        e.preventDefault();
                        const taskId=$(this).data('task-id');
                        $.post('/portal/task/'+taskId+'/timer',{action:'pause',csrf_token:csrf_token},function(r){
                          if(r.success){
                            isPaused=true;
                            $('#btnTimeStart').prop('disabled',false).find('span').text('Resume');
                            $('#btnTimePause').prop('disabled',true).hide();
                            $('#btnTimeStop').prop('disabled',false);
                            $timerBadge.removeClass('bg-primary').addClass('bg-warning').data('paused','true');
                          }else{
                            alert('Error: '+(r.error||'Unknown error'));
                          }
                        },'json').fail(function(xhr,status,error){
                          alert('Failed to pause timer: '+error);
                        });
                      });

                      $(document).on('click','#btnTimeStop',function(e){
                        e.preventDefault();
                        $('#timerStopModal').modal('show');
                      });

                      $('#btnBackdateTimesheet').off().on('click', function(){
                        alert('Untuk menambah entry gunakan Request Timesheet.');
                      });

                      // ========== Tambahan: Intercept Submit → Auto Stop (Engineer, Maintenance) ==========
                      let pendingConfirmForm = null;
                      $(document).on('submit', 'form:has(input[name="function"][value="confirm"])', function(e){
                        const $editForm = $('#edit_task_form');
                        if(!$editForm.length) return; // bukan halaman edit task

                        // Deteksi role & jenis task dari data-* pada form
                        const isEngineer    = ($editForm.data('is-engineer') === 1 || $editForm.data('is-engineer') === '1');
                        const isMaintenance = ($editForm.data('is-maintenance') === 1 || $editForm.data('is-maintenance') === '1');

                        // Deteksi timer berjalan dari badge
                        const badgeVisible  = ($timerBadge.length && !$timerBadge.hasClass('d-none'));
                        const pausedAttr    = $timerBadge.data('paused');
                        const pausedNow     = (pausedAttr === true || pausedAttr === 'true');
                        const timerRunning  = badgeVisible && !pausedNow;

                        if(isEngineer && isMaintenance && timerRunning){
                          e.preventDefault();
                          pendingConfirmForm = this;
                          $('#timerStopModal').modal('show'); // buka modal stop agar user isi deskripsi
                          return false;
                        }
                      });

                      $('#confirmStopBtn').off('click').on('click', function(){
                        const taskId=$(this).data('task-id');
                        const desc=$('#timerStopDescription').val().trim();
                        if(!desc){
                          alert('Description is required when stopping timer');
                          $('#timerStopDescription').focus();
                          return;
                        }
                        const formData=new FormData();
                        formData.append('action','stop');
                        formData.append('description',desc);
                        formData.append('csrf_token',csrf_token);
                        const fileInput=$('#timerAttachments')[0];
                        if(fileInput && fileInput.files && fileInput.files.length>0){
                          for(let i=0;i<fileInput.files.length;i++){
                            formData.append('attachments',fileInput.files[i]);
                          }
                        }
                        $('#confirmStopBtn').prop('disabled',true).text('Stopping...');
                        $.ajax({
                          url:'/portal/task/'+taskId+'/timer',
                          type:'POST',
                          data:formData,
                          processData:false,
                          contentType:false,
                          dataType:'json',
                          success:function(r){
                            if(r.success){
                              if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
                              $timerBadge.addClass('d-none').data('paused','false');
                              isPaused=false;
                              $('#btnTimeStart').prop('disabled',false).find('span').text('Time Start');
                              $('#btnTimePause').prop('disabled',true).hide();
                              $('#btnTimeStop').prop('disabled',true);
                              $('#timerStopModal').modal('hide');
                              $('#timerStopDescription').val('');
                              $('#timerAttachments').val('');
                              // Jika ada workflow submit yang tertunda → lanjutkan, else reload
                              if(pendingConfirmForm){
                                setTimeout(function(){
                                  try{ pendingConfirmForm.submit(); }catch(e){}
                                  pendingConfirmForm = null;
                                }, 300);
                              } else {
                                setTimeout(function(){location.reload();},1000);
                              }
                            }else{
                              alert('Error: '+(r.error||'Unknown error'));
                            }
                          },
                          error:function(xhr,status,error){
                            alert('Failed to stop timer: '+error);
                          },
                          complete:function(){
                            $('#confirmStopBtn').prop('disabled',false).text('Stop & Save');
                          }
                        });
                      });

                       $(document).on('submit', '#edit_task_form', function(){
                        $(this)
                          .find('.action-toolbar form input[name="function"], .action-toolbar form input[name="_workflow"]')
                          .each(function(){
                            $(this).prop('disabled', true).attr('data-disabled-by','edit-form');
                          });
                      });

                      // Section header toggle + persist (tetap)
                      $(document).on('click','.ts-sec-header',function(e){
                        if($(e.target).closest('.ts-meta-toggle').length) return;
                        const $hdr = $(this);
                        const target = $hdr.data('target');
                        const $body = $(target);
                        if(!$body.length) return;
                        const collapsed = $hdr.attr('data-collapsed') === 'true';
                        if(collapsed){
                          $body.slideDown(160).addClass('show');
                          $hdr.attr('data-collapsed','false').attr('aria-expanded','true')
                               .find('.toggle-label').text('Hide');
                          $hdr.find('.rotate-icon').css('transform','rotate(180deg)');
                        } else {
                          $body.slideUp(160).removeClass('show');
                          $hdr.attr('data-collapsed','true').attr('aria-expanded','false')
                               .find('.toggle-label').text('Show');
                          $hdr.find('.rotate-icon').css('transform','rotate(0deg)');
                        }
                        saveSectionState();
                      });

                      $(document).on('click','.ts-toggle-all',function(){
                        const action = $(this).data('action');
                        $('.ts-sec-header').each(function(){
                          const $hdr=$(this);
                          const target=$hdr.data('target');
                          const $body=$(target);
                          const isCollapsed = $hdr.attr('data-collapsed')==='true';
                          if(action==='expand' && isCollapsed){
                            $body.stop(true,true).slideDown(120).addClass('show');
                            $hdr.attr({'data-collapsed':'false','aria-expanded':'true'})
                                .find('.toggle-label').text('Hide');
                            $hdr.find('.rotate-icon').css('transform','rotate(180deg)');
                          }
                          if(action==='collapse' && !isCollapsed){
                            $body.stop(true,true).slideUp(120).removeClass('show');
                            $hdr.attr({'data-collapsed':'true','aria-expanded':'false'})
                                .find('.toggle-label').text('Show');
                            $hdr.find('.rotate-icon').css('transform','rotate(0deg)');
                          }
                        });
                        saveSectionState();
                      });

                      const SEC_STATE_KEY='ts_req_sections_state';
                      function saveSectionState(){
                        const state={};
                        $('.ts-sec-header').each(function(){
                          const key=$(this).closest('.ts-section').data('sec');
                          state[key]=$(this).attr('data-collapsed')==='false';
                        });
                        try{localStorage.setItem(SEC_STATE_KEY, JSON.stringify(state));}catch(e){}
                      }
                      function restoreSectionState(){
                        let state=null;
                        try{state=JSON.parse(localStorage.getItem(SEC_STATE_KEY)||'{}');}catch(e){}
                        if(!state) return;
                        $('.ts-sec-header').each(function(){
                          const $hdr=$(this);
                          const key=$hdr.closest('.ts-section').data('sec');
                          const shouldOpen=state[key];
                          const target=$hdr.data('target');
                          const $body=$(target);
                          if(shouldOpen){
                            $body.show().addClass('show');
                            $hdr.attr({'data-collapsed':'false','aria-expanded':'true'})
                                .find('.toggle-label').text('Hide');
                            $hdr.find('.rotate-icon').css('transform','rotate(180deg)');
                          }else{
                            $body.hide().removeClass('show');
                            $hdr.attr({'data-collapsed':'true','aria-expanded':'false'})
                                .find('.toggle-label').text('Show');
                            $hdr.find('.rotate-icon').css('transform','rotate(0deg)');
                          }
                        });
                      }
                      restoreSectionState();
                    });
                ]]>
            </script>

            <!-- ================== STYLES ================== -->
            <style>
                .select2-container--default .select2-selection--single {
                height: 35px; border: 1px solid #dee2e6; border-radius: 5px;
                }
                .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 28px; padding-left: 10px; padding-top: 1px;
                }
                .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 35px; width: 30px; top: 1px;
                }
                .select2-container .select2-selection--multiple { min-height: 35px; }

                .form-control[readonly]{background:#f8f9fa!important;}
                #pending_info{font-size:.85rem;}

                #runningTimerBadge.timer-badge {
                font-size: 18px !important; font-weight: 700 !important;
                padding: 10px 14px !important; border-radius: 6px !important;
                font-family: 'Courier New', monospace !important; letter-spacing: 0.5px !important;
                min-width: 85px !important; text-align: center !important;
                }
                .status-badge {
                font-size: 0.9rem !important; padding: 0.5rem 0.75rem !important;
                border-radius: 0.375rem !important; font-weight: 600 !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }

                .subtasks-btn {
                font-weight: 500 !important; border-radius: 6px !important;
                padding: 0.5rem 0.75rem !important; font-size: 0.9rem !important;
                transition: all 0.2s ease;
                }
                .subtasks-btn:hover {
                background-color: #6c757d !important; border-color: #6c757d !important;
                color: #fff !important; text-decoration:none; transform: translateY(-1px);
                }
                .form-control, .form-select {
                border-radius:0.375rem; border:1px solid #ced4da; font-size:0.875rem;
                transition:all 0.2s ease; text-align:left!important;
                }
                .form-control:focus, .form-select:focus {
                border-color:#007bff; box-shadow:0 0 0 0.2rem rgba(0,123,255,0.25);
                }
                .form-control[readonly] {
                background-color:#f8f9fa !important; border-color:#e9ecef !important;
                opacity:1 !important; color:#6c757d !important; cursor:not-allowed;
                }
                .ts-meta-toggle {
                --bs-btn-padding-y: .15rem;
                --bs-btn-padding-x: .45rem;
                --bs-btn-font-size: .65rem;
                line-height:1.1;
                }
                .ts-meta-badges .badge{
                font-size: .65rem;
                font-weight:500;
                letter-spacing:.25px;
                }
                .action-btn {
                padding:0.5rem 1rem !important; font-size:0.9rem !important;
                font-weight:500 !important; border-radius:6px !important;
                box-shadow:0 2px 4px rgba(0,0,0,0.1); transition:all 0.2s ease;
                }
                .action-btn:hover { transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }

                .task-header { margin-bottom:1.5rem; padding:1rem 0; border-bottom:1px solid #e9ecef; }
                .task-title { font-size:1.5rem; font-weight:600; color:#2c3e50; max-width:300px; overflow:hidden;
                text-overflow:ellipsis; white-space:nowrap; }

                .status-subtasks-container { display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; }
                .nav-tabs { border-bottom:2px solid #dee2e6; margin-bottom:1.5rem; }
                .nav-tabs .nav-link { color:#495057; font-weight:500; border-radius:0.5rem 0.5rem 0 0;
                margin-right:0.25rem; transition:all 0.2s ease; }
                .nav-tabs .nav-link.active { color:#007bff; background:#fff; border-color:#dee2e6 #dee2e6 #fff;
                font-weight:600; }

                .timesheet-table th, .timesheet-table td { vertical-align:middle; padding:0.75rem; }
                .timesheet-table th { background-color:#f8f9fa; font-weight:600; color:#495057; border-bottom:2px solid
                #dee2e6; }

                .group-header { background-color:#f8f9fa; cursor:pointer; transition:all 0.3s ease;
                border-radius:0.25rem; padding:0.75rem; }
                .group-header:hover { background-color:#e9ecef; transform:translateX(4px); }
                .collapse:not(.show){display:none;} .collapse.show{display:block;}
                .limit-2-lines { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
                overflow:hidden; text-overflow:ellipsis; word-break:break-word; }

                .form-control[type="file"] {
                padding:0.375rem 0.75rem; border:2px dashed #dee2e6; border-radius:0.5rem; background:#fafafa;
                transition:all 0.2s ease;
                }
                .form-control[type="file"]:hover { border-color:#007bff; background:#f0f8ff; }

                .load-more-wrapper { text-align:center; margin-top:12px; }
                .load-more-wrapper .btn { min-width:140px; }

                .ts-sec-header .rotate-icon{font-size:.75rem; opacity:.6;}
                .ts-sec-header:hover{background:#eef2f6;}
                .ts-sec-body .card{transition:box-shadow .2s;}
                .ts-sec-body .card:hover{box-shadow:0 4px 10px rgba(0,0,0,.08);}

                .badge-meta {
                background:#f1f3f5!important;
                color:#343a40!important;
                font-weight:500;
                font-size:.65rem;
                border:1px solid #e2e6ea;
                }
                .ts-sec-header .count-badge {
                background:#f1f3f5!important;
                color:#343a40!important;
                border:1px solid #e2e6ea;
                font-weight:600;
                }
                .meta-badge-row {
                margin-top:.35rem;
                display:flex;
                flex-wrap:wrap;
                gap:.35rem;
                }

                .table.table-hover tbody tr.no-hover:hover { background-color: transparent !important; }

                /* Task list: beri separator antar kolom + padding */
                .table.task-list-table th,
                .table.task-list-table td {
                padding: .6rem .9rem !important; /* sedikit lebih lega */
                vertical-align: middle;
                }

                /* Garis pemisah halus antar kolom supaya tidak terlihat menabrak */
                .table.task-list-table thead th + th,
                .table.task-list-table tbody td + td {
                border-left: 1px solid #eef1f4;
                }

                /* Pastikan badge Running tampil dan konsisten warnanya */
                .badge-running {
                display: inline-block !important;
                background: #198754 !important; /* sama dengan bg-success */
                color: #fff !important;
                font-weight: 600;
                padding: .15rem .45rem;
                border-radius: .25rem;
                font-size: .65rem;
                line-height: 1;
                vertical-align: baseline;
                }


                .assignee-count {
                display:inline-block;
                min-width:24px;
                padding:2px 6px;
                font-size:.65rem;
                font-weight:600;
                background:#eef1f4;
                border:1px solid #d9dde1;
                border-radius:12px;
                text-align:center;
                cursor:default;
                }
                /* Ganti definisi .ellipsis lama menjadi ini */
                .ellipsis {
                display: inline-block;
                width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                vertical-align: middle;
                }

                /* Aktifkan ellipsis langsung di sel kolom tertentu */
                .table.task-list-table td.clip {
                max-width: 0; /* penting untuk table-layout: fixed */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                }
                .table-group-header-row td {
                background:#f4f5f6;
                font-weight:600;
                font-size:.8rem;
                border-top:1px solid #d5d9dd !important;
                border-bottom:1px solid #d5d9dd !important;
                padding:.45rem .6rem;
                }
                .group-toggle-btn {
                background:#fff;
                border:1px solid #cfd5da;
                padding:2px 6px;
                border-radius:4px;
                font-size:.7rem;
                font-weight:600;
                cursor:pointer;
                margin-right:4px;
                }
                .group-toggle-btn i { font-size:.65rem; }
                .badge-running { background:#ffc107!important; color:#212529!important; font-weight:600; }
                .ts-btn-big { padding:.50rem .85rem !important; font-size:.60rem !important; font-weight:500; }
                .w-head { width:120px; }
                .w-member { width:120px; }

                .ts-btn-req { padding: .45rem .85rem !important; font-size: .8rem !important; }
                <!--                .ts-btn-big { padding: .55rem .95rem !important; font-size: .1000rem !important; font-weight:1000; }-->
                .ts-btn-action { padding:.35rem .6rem !important; font-size:.75rem !important; }
                .request-action-group .btn { min-width:44px; }
                .task-indent-wrapper { display:inline-block; }


                @media (max-width: 767.98px) {
                .timer-badge { font-size:16px !important; padding:8px 10px !important; min-width:70px !important; }
                .task-title { font-size:1.25rem; max-width:200px; }
                .action-btn { padding:0.375rem 0.75rem !important; font-size:0.8rem !important; }
                .status-badge { font-size:0.8rem !important; padding:0.375rem 0.5rem !important; }
                .nav-tabs { flex-wrap:nowrap; overflow-x:auto; }
                }
                @media (min-width:768px){
                .timer-badge { font-size:20px !important; padding:12px 16px !important; min-width:90px !important;}
                .task-title { font-size:1.75rem; }
                }
                :root{ --odoo-brand:#714b67; --odoo-brand-600:#68445e; --odoo-brand-50:#f5f1f4; }

                /* Base */
                .select2-container--default .select2-selection--single { height:35px; border:1px solid #dee2e6;
                border-radius:5px; }
                .select2-container--default .select2-selection--single .select2-selection__rendered { line-height:28px;
                padding-left:10px; padding-top:1px; }
                .select2-container--default .select2-selection--single .select2-selection__arrow { height:35px;
                width:30px; top:1px; }
                .select2-container .select2-selection--multiple { min-height:35px; }
                .form-control, .form-select { border-radius:.375rem; border:1px solid #ced4da; font-size:.875rem;
                transition:all .2s ease; text-align:left!important; }
                .form-control:focus, .form-select:focus { border-color:#007bff; box-shadow:0 0 0 .2rem
                rgba(0,123,255,.25); }
                .form-control[readonly]{ background:#f8f9fa!important; border-color:#e9ecef!important;
                opacity:1!important; color:#6c757d!important; cursor:not-allowed; }
                #pending_info{ font-size:.85rem; }

                /* Timer badge */
                #runningTimerBadge.timer-badge{
                font-size:18px!important; font-weight:700!important; padding:10px 14px!important;
                border-radius:6px!important;
                font-family:'Courier New',monospace!important; letter-spacing:.2px!important; min-width:85px!important;
                text-align:center!important;
                display:inline-flex; align-items:center; justify-content:center; line-height:1;
                }

                /* Status/Subtasks cluster */
                .status-badge{ font-size:.9rem!important; padding:.5rem .75rem!important;
                border-radius:.375rem!important; font-weight:600!important; box-shadow:0 1px 3px rgba(0,0,0,.1); }
                .subtasks-btn{ font-weight:500!important; border-radius:6px!important; padding:.5rem .75rem!important;
                font-size:.9rem!important; transition:all .2s ease; }
                .subtasks-btn:hover{ background:#6c757d!important; border-color:#6c757d!important; color:#fff!important;
                text-decoration:none; transform:translateY(-1px); }
                .status-subtasks-container{ display:flex; align-items:center; gap:.6rem; flex-wrap:wrap; }
                .status-subtasks-container > *{ margin:0!important; }

                /* Tables */
                .timesheet-table th, .timesheet-table td { vertical-align:middle; padding:.75rem; }
                .timesheet-table th { background:#f8f9fa; font-weight:600; color:#495057; border-bottom:2px solid
                #dee2e6; }

                /* Helpers */
                .group-header{ background:#f8f9fa; cursor:pointer; transition:all .3s ease; border-radius:.25rem;
                padding:.75rem; }
                .group-header:hover{ background:#e9ecef; transform:translateX(4px); }
                .collapse:not(.show){display:none;} .collapse.show{display:block;}
                .limit-2-lines { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
                overflow:hidden; text-overflow:ellipsis; word-break:break-word; }
                .form-control[type="file"]{ padding:.375rem .75rem; border:2px dashed #dee2e6; border-radius:.5rem;
                background:#fafafa; transition:all .2s ease; }
                .form-control[type="file"]:hover{ border-color:#007bff; background:#f0f8ff; }
                .load-more-wrapper { text-align:center; margin-top:12px; }
                .load-more-wrapper .btn { min-width:140px; }
                .ts-sec-header .rotate-icon{ font-size:.75rem; opacity:.6; }
                .ts-sec-header:hover{ background:#eef2f6; }
                .ts-sec-body .card{ transition:box-shadow .2s; }
                .ts-sec-body .card:hover{ box-shadow:0 6px 14px rgba(0,0,0,.08); }
                .badge-meta{ background:#f1f3f5!important; color:#343a40!important; font-weight:500; font-size:.65rem;
                border:1px solid #e2e6ea; }
                .ts-sec-header .count-badge{ background:#f1f3f5!important; color:#343a40!important; border:1px solid
                #e2e6ea; font-weight:600; }
                .meta-badge-row{ margin-top:.35rem; display:flex; flex-wrap:wrap; gap:.35rem; }
                .table.table-hover tbody tr.no-hover:hover { background-color:transparent!important; }

                /* Task list (list mode) — balik ke setelan awal */
                .table.task-list-table th, .table.task-list-table td { padding:.6rem .9rem!important;
                vertical-align:middle; }
                .table.task-list-table thead th + th, .table.task-list-table tbody td + td { border-left:1px solid
                #eef1f4; }
                .ellipsis{ display:inline-block; width:100%; white-space:nowrap; overflow:hidden;
                text-overflow:ellipsis; vertical-align:middle; }
                .table.task-list-table td.clip{ max-width:0; overflow:hidden; text-overflow:ellipsis;
                white-space:nowrap; }

                .table-group-header-row td{ background:#f4f5f6; font-weight:600; font-size:.8rem; border-top:1px solid
                #d5d9dd!important; border-bottom:1px solid #d5d9dd!important; padding:.45rem .6rem; }
                .group-toggle-btn{ background:#fff; border:1px solid #cfd5da; padding:2px 6px; border-radius:4px;
                font-size:.7rem; font-weight:600; cursor:pointer; margin-right:4px; }
                .group-toggle-btn i{ font-size:.65rem; }

                .badge-running{ background:#ffc107!important; color:#212529!important; font-weight:600; padding:.15rem
                .45rem; border-radius:.25rem; font-size:.65rem; line-height:1; vertical-align:baseline;
                display:inline-block!important; }
                .assignee-count{ display:inline-block; min-width:24px; padding:2px 6px; font-size:.65rem;
                font-weight:600; background:#eef1f4; border:1px solid #d9dde1; border-radius:12px; text-align:center;
                cursor:default; }

                /* Header block (duplicate-safe) */
                .task-header{ margin-bottom:1.2rem; padding:1rem 0; border-bottom:1px solid #e9ecef; }
                .task-title{ font-size:1.5rem; font-weight:600; color:#2c3e50; max-width:300px; overflow:hidden;
                text-overflow:ellipsis; white-space:nowrap; }
                .task-header .d-flex.align-items-center.flex-wrap{ column-gap:.5rem; row-gap:.35rem; }

                /* Toolbar (swap order: Request Timesheet berdampingan dengan Submit) */
                .action-toolbar{
                display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, auto));
                grid-auto-flow:row dense; gap:.5rem; align-items:stretch;
                }
                .action-btn{ padding:.42rem .75rem!important; font-size:.85rem!important; font-weight:500!important;
                border-radius:.5rem!important; box-shadow:0 2px 4px rgba(0,0,0,.1); transition:all .2s ease; }
                .action-btn:hover{ transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,0,0,.15); }
                .action-toolbar .btn, .action-toolbar .action-btn{ width:100%; display:inline-flex; align-items:center;
                justify-content:center; gap:.45rem; }

                .action-toolbar #btnTimeStart{ order:1; }
                .action-toolbar #btnTimeStop{ order:2; }
                .action-toolbar form{ order:4; }
                .action-toolbar #btnRequestTimesheet{ order:4; margin-left:0!important; }

                /* Bobot: tombol jadi item grid masing-masing */
                .action-toolbar .btn-group{ display:contents; }
                .action-toolbar .btn-group .action-btn{ padding:.42rem .75rem!important; font-size:.85rem!important; }

                /* Tabs segmented */
                .nav.nav-tabs.portal-tabs{ background:#f8f9fa; padding:.35rem; border-radius:.75rem; border:1px solid
                #e9ecef; }
                .nav.nav-tabs.portal-tabs .nav-link{ border:0!important; color:#495057; margin:0 .15rem;
                border-radius:.6rem!important; display:flex; align-items:center; gap:.35rem; transition:all .15s ease; }
                .nav.nav-tabs.portal-tabs .nav-link.active{ color:var(--odoo-brand)!important; background:#fff;
                box-shadow:0 1px 6px rgba(0,0,0,.06); border:1px solid #eaecef!important; }
                .nav.nav-tabs.portal-tabs .badge{ background:#212529!important; color:#fff!important; border:none;
                font-weight:700; }

                /* Request cards */
                .ts-btn-big{ padding:.5rem .8rem!important; font-size:.85rem!important; font-weight:600;
                border-radius:.5rem!important; }
                .request-action-group{ display:flex; gap:.5rem; flex-wrap:wrap; }
                @media (max-width:575.98px){
                .request-action-group{ display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
                .request-action-group .btn{ width:100%; }
                }

                /* Responsive */
                @media (max-width:767.98px){
                .timer-badge{ font-size:16px!important; padding:8px 10px!important; min-width:70px!important; }
                .task-title{ font-size:1.25rem; max-width:200px; }
                .nav.nav-tabs.portal-tabs{ position:sticky; top:56px; z-index:2; overflow-x:auto; white-space:nowrap; }
                #runningTimerBadge{ flex:1 1 100%; order:3; margin-top:.25rem; }
                .action-toolbar{ row-gap:.6rem; }
                }
                /* Toolbar: jangan full-width di desktop */
                .action-toolbar .btn,
                .action-toolbar .action-btn{ width:auto; }
                @media (max-width:767.98px){
                .action-toolbar .btn,
                .action-toolbar .action-btn{ width:100%; }
                }
                @media (min-width:768px){
                .timer-badge{ font-size:20px!important; padding:12px 16px!important; min-width:90px!important; }
                .task-title{ font-size:1.75rem; }
                }
            </style>

            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <!-- BREADCRUMB -->
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/portal">Home</a>
                </li>
                <t t-if="project_id and project and show_back_to_project_link">
                    <li class="breadcrumb-item">
                        <a href="/portal/projects">Projects</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a t-attf-href="/portal/projects/#{project.id}?view_type=form" t-esc="project.name"/>
                    </li>
                </t>
                <t t-if="parent_task">
                    <li class="breadcrumb-item">
                        <a t-attf-href="/portal/task/#{parent_task.id}?mode=edit" t-esc="parent_task.name"/>
                    </li>
                </t>
                <li class="breadcrumb-item active">
                    <t t-esc="page_name"/>
                </li>
            </ol>
            <!-- Flash Messages -->
            <t t-if="request.params.get('error')">
                <div class="alert alert-danger portal-auto-hide">
                    <t t-esc="request.params.get('error')"/>
                </div>
            </t>
            <t t-if="request.params.get('success')">
                <div class="alert alert-success portal-auto-hide">
                    <t t-esc="request.params.get('success')"/>
                </div>
            </t>

            <!-- ================== MODE NEW ================== -->
            <t t-if="kw.get('mode') == 'new'">
                <t t-set="current_parent_id" t-value="parent_id or kw.get('parent_id')"/>
                <t t-set="page_name" t-value="'New Subtask' if current_parent_id else 'New Task'"/>

                <div class="mb-3 d-flex align-items-center">
                    <a t-if="current_parent_id"
                       t-attf-href="/portal/tasks/parent/#{current_parent_id}"
                       class="btn btn-primary me-2">
                        <i class="fa fa-chevron-left me-1"/>Back
                    </a>

                    <!-- CHANGED: Back tanpa parent -->
                    <a t-if="not current_parent_id"
                       t-att-href="(is_pm and project_id) and ('/portal/tasks?project_id=%s' % project_id) or '/portal/tasks?groupby=project_id'"
                       class="btn btn-primary me-2">
                        <i class="fa fa-chevron-left me-1"/>Back
                    </a>

                    <h4 class="mb-0">
                        <t t-esc="page_name"/>
                    </h4>
                    <t t-if="can_create_task">
                        <button form="new_task_form" class="btn btn-link p-0 ms-2 mt-2" title="Save Task">
                            <i class="fa fa-cloud-download fa-md"/>
                        </button>
                    </t>
                </div>

                <form id="new_task_form" action="/portal/tasks" method="post"
                      t-att-data-project-id="project_id or (parent_task and parent_task.project_id.id) or ''"
                      t-att-data-project-name="project_name or (parent_task and parent_task.project_id.name) or ''"
                      t-att-data-customer-id="customer_id or ''"
                      t-att-data-customer-name="customer_name or ''"
                      t-att-data-project-label="z_name_of_project or ''">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <input type="hidden" name="mode" value="new"/>
                    <input type="hidden" name="parent_id" t-att-value="parent_id or ''"/>

                    <t t-if="parent_id and parent_task">
                        <input type="hidden" name="project_id" t-att-value="parent_task.project_id.id"/>
                    </t>
                    <t t-elif="project_id">
                        <input type="hidden" name="project_id" t-att-value="project_id"/>
                    </t>

                    <div class="row">
                        <div class="col-lg-6">
                            <!--                            <div class="mb-3">-->
                            <!--                                <label>Non Project Type</label>-->
                            <!--                                <select name="z_type_non_project" id="z_type_non_project_select" class="form-select">-->
                            <!--                                    <option value="">Project Type</option>-->
                            <!--                                    <option value="others">Others</option>-->
                            <!--                                </select>-->
                            <!--                            </di    v>-->

                            <div class="mb-3">
                                <label>Task Code</label>
                                <input type="text" class="form-control"
                                       t-att-value="parent_task and parent_task.name or '(Auto generated)'"
                                       readonly="readonly"/>
                                <small class="text-muted">Dibuat otomatis saat disimpan.</small>
                            </div>

                            <!-- Toggle Master Task Self-Create -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="z_master_task_self_create_ok"
                                           name="z_master_task_self_create_ok"/>
                                    <label class="form-check-label" for="z_master_task_self_create_ok">
                                        Name of tasks entries
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3 master-select-block">
                                <label>Name of Task
                                    <span class="text-danger">*</span>
                                </label>
                                <select name="z_master_task_id" class="form-select js-example-basic-single"
                                        data-required="1">
                                    <option value="">-- Select Master Task --</option>
                                    <t t-foreach="master_tasks" t-as="mt">
                                        <option t-att-value="mt.id">
                                            <t t-esc="mt.z_complete_name or mt.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>

                            <div class="mb-3 master-freetext-block" style="display:none;">
                                <label>Name of tasks entries
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" name="z_master_task_free_text"
                                       placeholder="e.g. Custom Task Name"/>
                            </div>

                            <t t-if="not parent_id and not project_id">
                                <div class="mb-3">
                                    <label>Project
                                        <span class="text-danger">*</span>
                                    </label>
                                    <select name="project_id" class="form-select js-example-basic-single"
                                            required="required">
                                        <option value="">-- Select Project --</option>
                                        <t t-foreach="request.env['project.project'].sudo().search([])" t-as="prj">
                                            <option t-att-value="prj.id">
                                                <t t-esc="prj.name"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="mb-3">
                                    <label>Project</label>
                                    <input type="text" class="form-control"
                                           t-att-value="project_name or (parent_task and parent_task.project_id.name) or ''"
                                           readonly="readonly"/>
                                </div>
                            </t>

                            <div class="mb-3">
                                <label>Name of Project</label>
                                <input type="text" name="z_project_name" class="form-control"
                                       t-att-value="z_name_of_project or ''" readonly="readonly"/>
                            </div>

                            <div class="mb-3">
                                <label>Customer</label>
                                <input type="text" id="customer_display" class="form-control"
                                       t-att-value="customer_name or ''" readonly="readonly"/>
                                <input type="hidden" name="partner_id" t-att-value="customer_id or ''"/>
                            </div>

                            <div class="mb-3">
                                <label>Head Assignees</label>
                                <select name="z_head_assignes_ids" multiple="multiple"
                                        class="form-control js-example-basic-multiple">
                                    <t t-foreach="employees" t-as="emp">
                                        <option t-att-value="emp.id"
                                                t-att-selected="z_head_assignes_ids and emp.id in z_head_assignes_ids">
                                            <t t-esc="emp.name"/>
                                        </option>
                                    </t>
                                </select>
                                <small class="text-muted">Hanya anggota Project Teams.</small>
                            </div>

                            <div class="mb-3">
                                <label>Member Assignees</label>
                                <select name="z_member_assignes_ids" multiple="multiple"
                                        class="form-control js-example-basic-multiple">
                                    <t t-foreach="employees" t-as="emp">
                                        <option t-att-value="emp.id"
                                                t-att-selected="z_member_assignes_ids and emp.id in z_member_assignes_ids">
                                            <t t-esc="emp.name"/>
                                        </option>
                                    </t>
                                </select>
                                <small class="text-muted">Hanya anggota Project Teams.</small>
                            </div>

                            <!-- Tags -->
                            <div class="mb-3">
                                <label>Tags</label>
                                <select name="tag_ids" class="form-control js-example-basic-multiple"
                                        multiple="multiple">
                                    <t t-foreach="request.env['project.tags'].sudo().search([])" t-as="tg">
                                        <option t-att-value="tg.id">
                                            <t t-esc="tg.name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>

                            <!-- Maintenance-only -->
                            <div class="mb-3">
                                <label>Technology</label>
                                <select name="z_technology_id" class="form-select js-example-basic-single">
                                    <option value="">--</option>
                                    <t t-foreach="technologies" t-as="tech">
                                        <option t-att-value="tech.id">
                                            <t t-esc="tech.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label>Severity</label>
                                <select name="z_severity_id" class="form-select js-example-basic-single">
                                    <option value="">--</option>
                                    <t t-foreach="severities" t-as="sev">
                                        <option t-att-value="sev.id">
                                            <t t-esc="sev.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label>Regional</label>
                                <select name="z_regional_id" class="form-select js-example-basic-single">
                                    <option value="">--</option>
                                    <t t-foreach="regionals" t-as="reg">
                                        <option t-att-value="reg.id">
                                            <t t-esc="reg.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>

                        </div>
                        <div class="col-lg-6">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label>Planned Start</label>
                                        <span class="text-danger">*</span>
                                        <input type="date" name="z_planned_start_date" class="form-control"
                                               data-required="1"/>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label>Planned End</label>
                                        <span class="text-danger">*</span>
                                        <input type="date" name="z_planned_end_date" class="form-control"
                                               data-required="1"/>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label>Actual Start Date</label>
                                        <input type="date" name="z_actual_start_date" class="form-control"
                                               readonly="readonly"/>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label>Actual End Date</label>
                                        <input type="date" name="z_actual_end_date" class="form-control"
                                               readonly="readonly"/>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label>Budget Mandays</label>
                                <input type="number" step="0.01" name="z_mandays_budget_entry" class="form-control"
                                       value="0.00" readonly="1"/>
                            </div>
                            <div class="mb-3">
                                <label>Actual Mandays</label>
                                <input type="number" step="0.01" name="z_actual_budget_mandays" class="form-control"
                                       value="0.00" readonly="readonly"/>
                            </div>

                            <div class="mb-3">
                                <label>Quality (%)</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" max="100" class="form-control" value="0.00"
                                           readonly="readonly"/>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Quality Entry (%)</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" max="100" name="z_quality_entry"
                                           class="form-control" value="0.00"/>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label>Progress (%)</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" max="100" name="z_progress_project"
                                           class="form-control" value="0.00" readonly="readonly"/>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Progress Entry (%)</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" max="100" name="z_progress_project_entry"
                                           class="form-control" value="0.00"/>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label>Bobot (%)</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" max="100" name="z_bobot_entry"
                                           class="form-control" value="0.00"/>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="z_end_task_ok_new"
                                       disabled="disabled" checked="checked"/>
                                <label class="form-check-label" for="z_end_task_ok_new">
                                    End Task
                                </label>
                            </div>

                        </div>
                    </div>

                    <ul class="nav nav-tabs portal-tabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#desc_new"
                                    type="button">Description
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="desc_new">
                            <div class="mt-3 mb-3">
                                <textarea class="form-control" name="description" rows="5"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </t>


            <t t-if="kw.get('mode') == 'edit' and task and task.z_type_non_project == 'others'">
                <div class="alert alert-info mb-3">
                </div>
                <div class="d-flex align-items-center mb-3">
                    <a href="/portal/tasks" class="btn btn-secondary me-2">
                        <i class="fa fa-chevron-left me-1"/>Back
                    </a>
                    <h4 class="mb-0">
                        <t t-esc="task.name"/>
                    </h4>
                    <t t-if="task.z_project_task_state not in ('approved1','approved2','done')">
                        <button id="btnRequestTimesheet" type="button"
                                class="btn btn-outline-primary ms-3"
                                t-att-data-task-id="task.id">
                            <i class="fa fa-clock-o me-1"></i>Request Timesheet
                        </button>
                    </t>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label class="form-label">Task Code</label>
                            <input type="text" class="form-control" t-att-value="task.name" readonly="readonly"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Project</label>
                            <input type="text" class="form-control"
                                   t-att-value="task.project_id and task.project_id.name or ''" readonly="readonly"/>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label class="form-label">Name of Project</label>
                            <input type="text" class="form-control"
                                   t-att-value="task.project_id.label_tasks or task.project_id.name or ''"
                                   readonly="readonly"/>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Name of Task (Master)</label>
                            <input type="text" class="form-control"
                                   t-att-value="task.z_master_task_id and task.z_master_task_id.z_name or ''"
                                   readonly="readonly"/>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs portal-tabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#timesheets_others"
                                type="button">
                            Timesheets
                            <span class="badge bg-secondary ms-2">
                                <t t-esc="ts_pager and ts_pager['total'] or (timesheets and len(timesheets) or 0)"/>
                            </span>
                        </button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div id="timesheets_others" class="tab-pane fade show active mt-3">
                        <t t-call="z_project.portal_timesheet_embed">
                            <t t-set="timesheets" t-value="timesheets"/>
                            <t t-set="timesheets_show" t-value="timesheets_show"/>
                            <t t-set="zeiten_map" t-value="zeiten_map"/>
                            <t t-set="ts_pager" t-value="ts_pager"/>
                            <t t-set="task" t-value="task"/>
                            <t t-set="pending_requests" t-value="pending_requests"/>
                            <t t-set="approved_requests" t-value="approved_requests"/>
                            <t t-set="rejected_requests" t-value="rejected_requests"/>
                            <t t-set="req_disp_map" t-value="req_disp_map"/>
                            <t t-set="can_approve_timesheet_for_task" t-value="can_approve_timesheet_for_task"/>
                            <t t-set="can_approve_timesheet" t-value="can_approve_timesheet"/>
                        </t>
                    </div>
                </div>

                <div class="mt-4">
                    <hr/>
                    <div id="task_chatter">
                        <h3>Communication history</h3>
                        <t t-set="object" t-value="task"/>
                        <t t-set="token" t-value="task.access_token"/>
                        <t t-call="portal.message_thread"/>
                    </div>
                </div>
            </t>


            <!-- ================== MODE EDIT ================== -->
            <t t-if="kw.get('mode') == 'edit' and task and task.z_type_non_project != 'others'">
                <form id="edit_task_form"
                      t-att-data-is-admin="1 if is_admin else 0"
                      t-att-data-is-pm="1 if is_pm else 0"
                      t-att-data-is-head="1 if is_head else 0"
                      t-att-data-is-head-engineer="1 if is_head else 0"
                      t-att-data-is-engineer="1 if is_engineer else 0"
                      t-att-data-is-delivery="1 if is_delivery_support else 0"
                      t-att-data-form-readonly-all="1 if portal_task_form_readonly_all else 0">
                    t-attf-action="/portal/tasks/#{task.id}"
                    method="post">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <input type="hidden" name="mode" value="edit"/>
                    <input type="hidden" name="partner_id_hidden" t-att-value="task.partner_id.id or ''"/>

                    <div class="task-header">
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <div class="d-flex align-items-center flex-wrap">
                                <!-- CHANGED: Back behavior -->
                                <a t-att-href="
                  task.parent_id
                    and ('/portal/tasks/parent/%s' % (root_task and root_task.id or task.parent_id.id))
                    or (
                      (is_pm and task.project_id)
                        and ('/portal/tasks?project_id=%s&amp;groupby=&amp;sortby=terlama' % task.project_id.id)
                      or ((is_head_engineer or is_engineer or is_support) and '/portal/tasks?groupby=project_id')
                      or (task.project_id and '/portal/tasks?project_id=%s&amp;groupby=&amp;sortby=terlama' % task.project_id.id)
                      or '/portal/tasks'
                    )
                "
                                   class="btn btn-primary d-flex align-items-center me-2">
                                    <i class="fa fa-chevron-left me-1"/>
                                    <span class="d-none d-sm-inline">Back</span>
                                </a>

                                <h4 class="mb-0 me-3 task-title">
                                    <span t-field="task.name"/>
                                </h4>

                                <div class="d-flex align-items-center gap-2">
                                    <button type="submit" class="btn btn-link p-1" form="edit_task_form"
                                            title="Save Task">
                                        <i class="fa fa-cloud-download fa-md"></i>
                                    </button>
                                    <span id="runningTimerBadge"
                                          class="badge bg-primary timer-badge d-none"
                                          t-att-data-start="active_timer_start"
                                          t-att-data-paused="active_timer_paused and 'true' or 'false'">00:00:00
                                    </span>
                                </div>
                                <!-- Prev/Next navigation -->
                                <div class="ms-2 d-flex align-items-center gap-1"
                                     t-if="nav_total and nav_total &gt; 1">
                                    <a t-if="nav_prev_id"
                                       t-attf-href="/portal/task/#{nav_prev_id}?mode=edit"
                                       class="btn btn-sm btn-outline-secondary"
                                       title="Previous task">
                                        <i class="fa fa-chevron-left"></i>
                                    </a>
                                    <span class="text-muted small">
                                        <t t-esc="nav_index"/>/
                                        <t t-esc="nav_total"/>
                                    </span>
                                    <a t-if="nav_next_id"
                                       t-attf-href="/portal/task/#{nav_next_id}?mode=edit"
                                       class="btn btn-sm btn-outline-secondary"
                                       title="Next task">
                                        <i class="fa fa-chevron-right"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="status-subtasks-container">
                                <span class="btn btn-light d-flex align-items-center status-badge">
                                    <t t-if="task.z_project_task_state=='new'">New</t>
                                    <t t-elif="task.z_project_task_state=='in_progress'">In Progress</t>
                                    <t t-elif="task.z_project_task_state=='approved1'">The First Approval</t>
                                    <t t-elif="task.z_project_task_state=='approved2'">The Second Approval</t>
                                    <t t-elif="task.z_project_task_state=='done'">Finished</t>
                                    <t t-elif="task.z_project_task_state=='reject'">Rejected</t>
                                    <t t-elif="task.z_project_task_state=='cancel'">Cancelled</t>
                                    <t t-else="">
                                        <t t-esc="task.z_project_task_state"/>
                                    </t>
                                </span>
                                <t t-if="is_pm or is_head_engineer">
                                    <a t-attf-href="/portal/tasks/parent/#{task.id}"
                                       class="btn btn-light d-flex align-items-center subtasks-btn">
                                        <i class="fa fa-tasks me-1"/>Subtasks
                                        <span class="badge bg-secondary text-white ms-1">
                                            <t t-esc="len(subtasks) if subtasks else 0"/>
                                        </span>
                                    </a>
                                    <a href="#" class="btn btn-light d-flex align-items-center btn-new-subtask"
                                       t-att-data-parent-id="task.id" title="New Subtask">
                                        <i class="fa fa-plus me-1"></i>
                                        New Subtask
                                    </a>
                                </t>
                            </div>
                        </div>
                    </div>

                    <div class="action-toolbar mb-4">
                        <!-- Time Start/Stop tetap -->
                        <t t-if="task.z_project_task_state not in ('approved1','approved2','done')">
                            <button id="btnTimeStart" type="button" class="btn btn-primary action-btn"
                                    t-att-data-task-id="task.id" t-att-disabled="active_timer_running">
                                <i class="fa fa-play"></i>
                                <span>Time Start</span>
                            </button>
                        </t>
                        <t t-if="task.z_project_task_state not in ('approved1','approved2','done') and not (task.project_id and task.project_id.z_type_in_project == 'maintenance' and is_engineer and not (is_pm or is_admin or is_head_engineer))">
                            <button id="btnTimeStop" type="button" class="btn btn-primary action-btn"
                                    data-bs-toggle="modal" data-bs-target="#timerStopModal"
                                    t-att-data-task-id="task.id" t-att-disabled="not active_timer_running">
                                <i class="fa fa-stop"></i>
                                <span>Time Stop</span>
                            </button>
                        </t>

                        <!-- Calculate Bobot -->
                        <t t-if="show_metrics and (is_pm) and task.z_project_task_state not in ('approved2','done')">
                            <button type="button"
                                    class="btn btn-primary action-btn btn-calculate-bobot"
                                    t-att-data-task-id="task.id">
                                <i class="fa fa-calculator me-1"></i>Calculate Bobot
                            </button>
                        </t>

                        <!-- Submit (in_progress) -->
                        <t t-if="task.z_project_task_state == 'in_progress' and can_submit_task and not active_timer_running">
                            <form t-attf-action="/portal/task/#{task.id}" method="post" class="d-inline-block">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="_workflow" value="1"/>
                                <!--                                <input type="hidden" name="function" value="confirm"/>-->
                                <button type="submit" class="btn btn-primary action-btn">
                                    <i class="fa fa-check me-1"></i>Submit
                                </button>
                            </form>
                        </t>

                        <!-- Approve/Reject approved1 -->
                        <t t-if="task.z_project_task_state == 'approved1' and (is_head_engineer or is_pm or is_admin)">
                            <form t-attf-action="/portal/task/#{task.id}" method="post" class="d-inline-block me-1">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="_workflow" value="1"/>
                                <!--                                <input type="hidden" name="function" value="confirm"/>-->
                                <button type="submit" class="btn btn-primary action-btn">
                                    <i class="fa fa-check me-1"></i>Approve
                                </button>
                            </form>
                            <form t-attf-action="/portal/task/#{task.id}" method="post" class="d-inline-block">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="_workflow" value="1"/>
                                <input type="hidden" name="function" value="reject"/>
                                <button type="submit" class="btn btn-primary action-btn">
                                    <i class="fa fa-times me-1"></i>Reject
                                </button>
                            </form>
                        </t>

                        <!-- Done/Reject approved2 -->
                        <t t-if="task.z_project_task_state == 'approved2' and can_approve_task">
                            <form t-attf-action="/portal/task/#{task.id}" method="post" class="d-inline-block me-1">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="_workflow" value="1"/>
                                <!--                                <input type="hidden" name="function" value="confirm"/>-->
                                <button type="submit" class="btn btn-primary action-btn">Done
                                </button>
                            </form>
                            <form t-attf-action="/portal/task/#{task.id}" method="post" class="d-inline-block">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="_workflow" value="1"/>
                                <input type="hidden" name="function" value="reject"/>
                                <button type="submit" class="btn btn-primary action-btn">
                                    <i class="fa fa-times me-1"></i>Reject
                                </button>
                            </form>
                        </t>

                        <t t-if="task.z_project_task_state not in ('approved1','approved2','done')">
                            <button id="btnRequestTimesheet" type="button"
                                    class="btn btn-primary action-btn"
                                    t-att-data-task-id="task.id">
                                <i class="fa fa-clock-o me-1"></i>Request Timesheet
                            </button>
                        </t>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label>Task Code</label>
                                <input type="text" class="form-control" t-att-value="task.name" readonly="readonly"/>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="z_master_task_self_create_ok_edit"
                                           name="z_master_task_self_create_ok"
                                           t-att-checked="task.z_master_task_self_create_ok and 'checked' or None"/>
                                    <label class="form-check-label" for="z_master_task_self_create_ok_edit">
                                        Not Tasks Exist?
                                    </label>
                                </div>
                            </div>

                            <!-- Bungkus select existing di container agar bisa di-hide -->
                            <div class="mb-3 master-select-block-edit"
                                 t-att-style="task.z_master_task_self_create_ok and 'display:none;' or ''">
                                <label>Name of Task</label>
                                <select name="z_master_task_id" class="form-select js-example-basic-single">
                                    <option value="">--</option>
                                    <t t-foreach="master_tasks" t-as="mt">
                                        <option t-att-value="mt.id"
                                                t-att-selected="task.z_master_task_id and mt.id == task.z_master_task_id.id">
                                            <t t-esc="mt.z_complete_name or mt.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>

                            <div class="mb-3 master-freetext-block-edit"
                                 t-att-style="task.z_master_task_self_create_ok and '' or 'display:none;'">
                                <label>Name of tasks entries</label>
                                <input type="text" class="form-control" name="z_master_task_free_text"
                                       t-att-value="task.z_master_task_free_text or ''"/>
                            </div>
                            <div class="mb-3">
                                <label>Project</label>
                                <select name="project_id" class="form-select js-example-basic-single"
                                        t-att-disabled="'disabled' if (parent_id or project_id) else False">
                                    <option value="">--</option>
                                    <t t-foreach="request.env['project.project'].sudo().search([])" t-as="prj">
                                        <option t-att-value="prj.id"
                                                t-att-selected="prj.id==task.project_id.id">
                                            <t t-esc="prj.name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label>Name of Project</label>
                                <input type="text" class="form-control" readonly="readonly"
                                       t-att-value="task.project_id.label_tasks or task.project_id.name or ''"/>
                            </div>
                            <div class="mb-3">
                                <label>Customer</label>
                                <input type="text" class="form-control" readonly="readonly"
                                       t-att-value="task.partner_id.name or ''"/>
                            </div>
                            <div class="mb-3">
                                <label>Head Assignees</label>
                                <select name="z_head_assignes_ids" multiple="multiple"
                                        class="form-control js-example-basic-multiple">
                                    <t t-foreach="employees" t-as="e">
                                        <option t-att-value="e.id"
                                                t-att-selected="e.id in task.z_head_assignes_ids.ids">
                                            <t t-esc="e.name"/>
                                        </option>
                                    </t>
                                </select>
                                <small class="text-muted">Filtered by Project Teams.</small>
                            </div>

                            <div class="mb-3">
                                <label>Member Assignees</label>
                                <select name="z_member_assignes_ids" multiple="multiple"
                                        class="form-control js-example-basic-multiple">
                                    <t t-foreach="employees" t-as="e">
                                        <option t-att-value="e.id"
                                                t-att-selected="e.id in task.z_member_assignes_ids.ids">
                                            <t t-esc="e.name"/>
                                        </option>
                                    </t>
                                </select>
                                <small class="text-muted">Filtered by Project Teams.</small>
                            </div>
                            <div class="mb-3" t-att-style="'display:' + ('block' if task.z_is_maintenance else 'none')">
                                <label>Technology</label>
                                <select name="z_technology_id" class="form-select js-example-basic-single">
                                    <option value="">select...</option>
                                    <t t-foreach="technologies" t-as="tech">
                                        <option t-att-value="tech.id" t-att-selected="tech.id==task.z_technology_id.id">
                                            <t t-esc="tech.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="mb-3" t-att-style="'display:' + ('block' if task.z_is_maintenance else 'none')">
                                <label>Severity</label>
                                <select name="z_severity_id" class="form-select js-example-basic-single">
                                    <option value="">select...</option>
                                    <t t-foreach="severities" t-as="sev">
                                        <option t-att-value="sev.id" t-att-selected="sev.id==task.z_severity_id.id">
                                            <t t-esc="sev.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="mb-3" t-att-style="'display:' + ('block' if task.z_is_maintenance else 'none')">
                                <label>Regional</label>
                                <select name="z_regional_id" class="form-select js-example-basic-single">
                                    <option value="">select...</option>
                                    <t t-foreach="regionals" t-as="reg">
                                        <option t-att-value="reg.id" t-att-selected="reg.id==task.z_regional_id.id">
                                            <t t-esc="reg.z_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label>Planned Start Date</label>
                                        <input type="date" class="form-control" name="z_planned_start_date"
                                               t-att-value="task.z_planned_start_date or ''"/>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label>Planned End Date</label>
                                        <input type="date" class="form-control" name="z_planned_end_date"
                                               t-att-value="task.z_planned_end_date or ''"/>
                                    </div>
                                </div>
                            </div>

                            <t t-if="show_metrics">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label>Actual Start Date</label>
                                            <input type="date" class="form-control" name="z_actual_start_date"
                                                   t-att-value="task.z_actual_start_date or ''" readonly="readonly"/>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label>Actual End Date</label>
                                            <input type="date" class="form-control" name="z_actual_end_date"
                                                   t-att-value="task.z_actual_end_date or ''" readonly="readonly"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label>Bobot (%)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" max="100" class="form-control"
                                               name="z_bobot_entry"
                                               t-att-value="'{:.2f}'.format(task.z_bobot_entry) if task.z_bobot_entry else '0.00'"/>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label>Budget Mandays</label>
                                    <input type="number" step="0.01" class="form-control" name="z_mandays_budget_entry"
                                           t-att-value="'{:.2f}'.format(task.z_mandays_budget_entry) if task.z_mandays_budget_entry else '0.00'"
                                           readonly="1"/>
                                </div>
                                <div class="mb-3">
                                    <label>Actual Mandays</label>
                                    <input type="number" step="0.01" class="form-control" name="z_actual_budget_mandays"
                                           t-att-value="'{:.2f}'.format(task.z_actual_budget_mandays) if task.z_actual_budget_mandays else '0.00'"
                                           readonly="readonly"/>
                                </div>
                                <div class="mb-3">
                                    <label>Progress (%)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" max="100" class="form-control"
                                               name="z_progress_project"
                                               t-att-value="'{:.2f}'.format(task.z_progress_project) if task.z_progress_project else '0.00'"
                                               readonly="readonly"/>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="z_end_task_ok"
                                           name="z_end_task_ok"
                                           t-att-checked="task.z_end_task_ok and 'checked' or None"
                                           disabled="disabled"/>
                                    <label class="form-check-label" for="z_end_task_ok">
                                        End Task
                                    </label>
                                </div>
                                <t t-if="task.z_end_task_ok">
                                    <div class="mb-3">
                                        <label>Progress Entry (%)</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" min="0" max="100"
                                                   class="form-control"
                                                   name="z_progress_project_entry"
                                                   t-att-value="'{:.2f}'.format(task.z_progress_project_entry) if task.z_progress_project_entry else '0.00'"
                                                   t-att-readonly="portal_task_form_readonly and 'readonly' or None"
                                                   t-att-disabled="portal_task_form_readonly and 'disabled' or None"/>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </t>
                                <t t-if="show_quality">
                                    <div class="mb-3">
                                        <label>Quality</label>
                                        <div class="input-group">
                                            <input type="number"
                                                   step="0.01"
                                                   min="0"
                                                   max="100"
                                                   class="form-control"
                                                   t-att-value="task.z_quality_calculation and '{:.2f}'.format(task.z_quality_calculation) or '0.00'"
                                                   readonly="readonly"/>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>

                                    <!-- Quality Entry -->
                                    <div class="mb-3">
                                        <label>Quality Entry</label>
                                        <div class="input-group">
                                            <input type="number"
                                                   step="0.01"
                                                   min="0"
                                                   max="100"
                                                   name="z_quality_entry"
                                                   class="form-control"
                                                   t-att-value="task.z_quality_entry and '{:.2f}'.format(task.z_quality_entry) or '0.00'"
                                                   t-att-readonly="task.z_project_task_state != 'done' and 'readonly' or None"
                                                   t-att-disabled="task.z_project_task_state != 'done' and 'disabled' or None"/>
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <small class="text-muted" t-if="task.z_project_task_state != 'done'">
                                            Hanya bisa diisi saat status task = Done.
                                        </small>
                                    </div>
                                </t>
                            </t>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs portal-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation" t-if="is_pm or is_head_engineer">
                            <button class="nav-link active" id="description-tab" data-bs-toggle="tab"
                                    data-bs-target="#description" type="button" role="tab">Description
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link"
                                    t-att-class="'nav-link active' if (is_engineer and not (is_pm or is_head_engineer)) else 'nav-link'"
                                    id="timesheet-tab" data-bs-toggle="tab" data-bs-target="#timesheets" type="button"
                                    role="tab">
                                Timesheets
                                <span class="badge bg-secondary ms-2">
                                    <t t-esc="ts_pager and ts_pager['total'] or (timesheets and len(timesheets) or 0)"/>
                                </span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" t-if="is_pm or is_head_engineer">
                            <button class="nav-link" id="subtask-tab" data-bs-toggle="tab" data-bs-target="#subtasks"
                                    type="button" role="tab">
                                Subtasks
                                <span class="badge bg-secondary ms-2">
                                    <t t-esc="len(subtasks) if subtasks else 0"/>
                                </span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation"
                            t-if="(is_pm or is_head_engineer or is_support) and not is_engineer">
                            <button class="nav-link" id="invoice-plan-tab" data-bs-toggle="tab"
                                    data-bs-target="#invoice-plan" type="button" role="tab">
                                Invoice Plan
                                <span class="badge bg-secondary ms-2">
                                    <t t-esc="ip_pager and ip_pager['total'] or (task.z_invoice_plan_ids and len(task.z_invoice_plan_ids) or 0)"/>
                                </span>
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <!-- Description -->
                        <div class="tab-pane fade"
                             t-att-class="'tab-pane fade show active' if (is_pm or is_head_engineer) else 'tab-pane fade'"
                             id="description" t-if="is_pm or is_head_engineer">
                            <div class="mt-3 mb-3">
                                <textarea class="form-control" name="description" rows="5"
                                          t-att-value="task_description"></textarea>
                            </div>
                        </div>

                        <!-- Timesheets -->
                        <div class="tab-pane fade"
                             t-att-class="'tab-pane fade show active' if (is_engineer and not (is_pm or is_head_engineer)) else 'tab-pane fade'"
                             id="timesheets">
                            <t t-set="pending_new"
                               t-value="pending_requests.filtered(lambda r: req_disp_map.get(r.id, {}).get('type') == 'new')"/>
                            <t t-set="pending_corr"
                               t-value="pending_requests.filtered(lambda r: req_disp_map.get(r.id, {}).get('type') == 'correction')"/>

                            <div class="mt-3 mb-3">

                                <!-- History Collapse -->
                                <!--                                <div class="mt-3">-->
                                <!--                                    <button class="btn btn-sm btn-outline-secondary" type="button"-->
                                <!--                                            data-bs-toggle="collapse" data-bs-target="#historyCollapse">-->
                                <!--                                        <i class="fa fa-history me-1"></i>Show / Hide History-->
                                <!--                                    </button>-->
                                <!--                                </div>-->

                                <!-- Global Section Toggles -->
                                <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary ts-toggle-all"
                                            data-action="expand">Expand All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ts-toggle-all"
                                            data-action="collapse">Collapse All
                                    </button>
                                </div>

                                <!-- Section Wrapper Component -->
                                <t t-set="section_defs" t-value="[
  {'key':'pending_new','title':'Pending New Entries','records': pending_new,'badge':'bg-light text-dark'},
  {'key':'pending_corr','title':'Pending Corrections','records': pending_corr,'badge':'bg-light text-dark'},
  {'key':'rejected','title':'Rejected (Last 20)','records': rejected_requests,'badge':'bg-light'},
  {'key':'approved','title':'Approved (Last 20)','records': approved_requests,'badge':'bg-light'},
]"/>

                                <!-- Loop Semua Section -->
                                <t t-foreach="section_defs" t-as="sec">
                                    <t t-set="recset" t-value="sec.get('records')"/>
                                    <div class="ts-section mb-3" t-att-data-sec="sec.get('key')">
                                        <!-- Header -->
                                        <div class="d-flex align-items-center justify-content-between ts-sec-header px-3 py-2 rounded border"
                                             t-att-style="'background:#f8f9fa; border-left:5px solid %s; cursor:pointer;' % sec.get('color')"
                                             t-att-data-target="'#sec_body_'+sec.get('key')"
                                             data-collapsed="true"
                                             role="button"
                                             t-att-aria-controls="'sec_body_'+sec.get('key')"
                                             aria-expanded="false">
                                            <div class="d-flex align-items-center flex-wrap">
                                                <strong class="me-2" t-esc="sec.get('title')"/>
                                                <span class="badge count-badge ms-1"
                                                      t-esc="(recset and len(recset)) or 0"/>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="text-muted small toggle-label">Show</span>
                                                <i class="fa fa-chevron-down rotate-icon" style="transition:.25s;"></i>
                                            </div>
                                        </div>

                                        <!-- Body (Collapsed default) -->
                                        <div class="collapse ts-sec-body" t-att-id="'sec_body_'+sec.get('key')">
                                            <t t-if="recset">
                                                <div class="row g-2 mt-2">
                                                    <t t-foreach="recset" t-as="rq">
                                                        <t t-set="rinfo" t-value="req_disp_map.get(rq.id) or {}"/>
                                                        <t t-set="emp_name"
                                                           t-value="(rq.z_employee_id and rq.z_employee_id.name) or (rq.z_timesheet_id and rq.z_timesheet_id.employee_id and rq.z_timesheet_id.employee_id.name) or rq.create_uid.name"/>
                                                        <div class="col-12">
                                                            <div class="card shadow-sm border-0"
                                                                 t-att-style="'border-left:4px solid %s;'"
                                                                 t-att-data-req-id="rq.id">
                                                                <div class="card-body p-3 d-flex justify-content-between">
                                                                    <div class="me-3">
                                                                        <div class="d-flex align-items-center mb-1 flex-wrap">
                                                                            <strong class="me-2"
                                                                                    t-esc="emp_name or '-'"/>
                                                                            <!-- TYPE Badge -->
                                                                            <t t-if="rinfo.get('type')=='new'">
                                                                                <span class="badge bg-primary">New
                                                                                </span>
                                                                            </t>
                                                                            <t t-elif="rinfo.get('type')=='correction'">
                                                                                <span class="badge bg-purple"
                                                                                      style="background:#6f42c1;">
                                                                                    Correction
                                                                                </span>
                                                                            </t>
                                                                            <!-- STATE Badge (derived by section) -->
                                                                            <t t-if="sec.get('key').startswith('pending')">
                                                                                <span class="badge bg-warning text-dark ms-2">
                                                                                    Waiting
                                                                                </span>
                                                                            </t>
                                                                            <t t-elif="sec.get('key')=='approved'">
                                                                                <span class="badge bg-success ms-2">
                                                                                    Approved
                                                                                </span>
                                                                            </t>
                                                                            <t t-elif="sec.get('key')=='rejected'">
                                                                                <span class="badge bg-danger ms-2">
                                                                                    Rejected
                                                                                </span>
                                                                            </t>
                                                                        </div>

                                                                        <!-- Content -->
                                                                        <div class="small mb-1">
                                                                            <t t-if="rinfo.get('type')=='correction'">
                                                                                <strong class="text-muted">Original:
                                                                                </strong>
                                                                                <t t-esc="rinfo.get('ori_start') or '-'"/>
                                                                                →
                                                                                <t t-esc="rinfo.get('ori_end') or '-'"/>
                                                                                <br/>
                                                                            </t>
                                                                            <strong class="text-primary">
                                                                                <t t-if="sec.get('key')=='approved'">
                                                                                    Final:
                                                                                </t>
                                                                                <t t-elif="sec.get('key')=='rejected'">
                                                                                    Proposed:
                                                                                </t>
                                                                                <t t-else="">Actual:</t>
                                                                            </strong>
                                                                            <t t-esc="rinfo.get('new_start') or '-'"/>
                                                                            →
                                                                            <t t-esc="rinfo.get('new_end') or '-'"/>
                                                                            (
                                                                            <t t-esc="rinfo.get('hours') or 0"/>h)
                                                                        </div>
                                                                        <div class="text-muted small"
                                                                             t-esc="rinfo.get('desc') or ''"/>

                                                                        <t t-if="sec.get('key')=='rejected' and (rinfo.get('reject_reason_desc') or rinfo.get('reject_reason'))">
                                                                            <div class="alert alert-danger py-1 px-2 mt-2 mb-0">
                                                                                <i class="fa fa-exclamation-triangle me-1"></i>
                                                                                <strong>Rejected:</strong>
                                                                                <span t-esc="rinfo.get('reject_reason_desc') or rinfo.get('reject_reason')"/>
                                                                            </div>
                                                                        </t>

                                                                        <!-- Badge Meta Collapse -->
                                                                        <!--                                                                        <div class="collapse mt-2 ts-meta-badges"-->
                                                                        <!--                                                                             t-att-id="'req_meta_'+str(rq.id)">-->
                                                                        <div class="mt-1 d-flex flex-wrap gap-1">
                                                                            <span class="badge bg-light text-dark">
                                                                                <t t-esc="task.project_id.label_tasks or task.project_id.name or ''"/>
                                                                            </span>
                                                                            <span class="badge bg-light text-dark">
                                                                                <t t-esc="task.name"/>
                                                                            </span>
                                                                            <t t-if="task.z_master_task_id">
                                                                                <span class="badge bg-light text-dark">
                                                                                    <t t-esc="task.z_master_task_id.z_name"/>
                                                                                </span>
                                                                            </t>
                                                                            <t t-if="task.project_id">
                                                                                <span class="badge bg-light text-dark">
                                                                                    <t t-esc="task.project_id.name"/>
                                                                                </span>
                                                                            </t>
                                                                        </div>
                                                                        <!--                                                                        </div>-->
                                                                    </div>

                                                                    <!-- Actions -->
                                                                    <div class="text-end">
                                                                        <t t-if="can_approve_timesheet and sec.get('key').startswith('pending')">
                                                                            <!--                                                                            <div class="btn-group">-->
                                                                            <!--                                                                                <button type="button"-->
                                                                            <!--                                                                                        class="btn btn-sm btn-success btn-req-approve"-->
                                                                            <!--                                                                                        t-att-data-id="rq.id"-->
                                                                            <!--                                                                                        t-att-data-type="rinfo.get('type')">-->
                                                                            <!--                                                                                    <i class="fa fa-check"></i>-->
                                                                            <!--                                                                                </button>-->
                                                                            <!--                                                                                <button type="button"-->
                                                                            <!--                                                                                        class="btn btn-sm btn-outline-danger btn-req-reject"-->
                                                                            <!--                                                                                        t-att-data-id="rq.id"-->
                                                                            <!--                                                                                        t-att-data-type="rinfo.get('type')">-->
                                                                            <!--                                                                                    <i class="fa fa-times"></i>-->
                                                                            <!--                                                                                </button>-->
                                                                            <!--                                                                            </div>-->
                                                                            <div class="request-action-group d-flex gap-2">
                                                                                <button type="button"
                                                                                        class="btn btn-success ts-btn-big btn-req-approve"
                                                                                        t-att-data-id="rq.id"
                                                                                        t-att-data-type="rinfo.get('type')">
                                                                                    <i class="fa fa-check me-1"></i>
                                                                                    Approve
                                                                                </button>
                                                                                <button type="button"
                                                                                        class="btn btn-outline-danger ts-btn-big btn-req-reject"
                                                                                        t-att-data-id="rq.id"
                                                                                        t-att-data-type="rinfo.get('type')">
                                                                                    <i class="fa fa-times me-1"></i>
                                                                                    Reject
                                                                                </button>
                                                                            </div>
                                                                        </t>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </t>
                                                </div>
                                            </t>
                                            <t t-else="">
                                                <div class="alert alert-light py-2 mt-2 mb-0">
                                                    <t t-if="sec.get('key')=='pending_new'">No pending new requests.</t>
                                                    <t t-elif="sec.get('key')=='pending_corr'">No pending corrections.
                                                    </t>
                                                    <t t-elif="sec.get('key')=='approved'">No approved history yet.</t>
                                                    <t t-elif="sec.get('key')=='rejected'">No rejected history yet.</t>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </t>

                                <!-- ========== TIMESHEET LIST (Desktop) ========== -->
                                <h5 class="mt-4 mb-2">Timesheet Entries</h5>
                                <div class="d-none d-md-block">
                                    <t t-if="timesheets_show or timesheets">
                                        <div class="table-responsive">
                                            <table class="table table-striped timesheet-table">
                                                <thead>
                                                    <tr>
                                                        <th>Start</th>
                                                        <th>End</th>
                                                        <th>Employee</th>
                                                        <th>Description</th>
                                                        <th>Time Spent</th>
                                                        <th>Status</th>
                                                        <th style="width:80px;">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="timesheet_table_body">
                                                    <t t-foreach="timesheets_show or timesheets or []" t-as="ts">
                                                        <tr>
                                                            <td>
                                                                <t t-if="zeiten_map.get(ts.id)">
                                                                    <t t-esc="zeiten_map.get(ts.id).get('start_wib')"/>
                                                                </t>
                                                            </td>
                                                            <td>
                                                                <t t-if="zeiten_map.get(ts.id) and zeiten_map.get(ts.id).get('end_wib')">
                                                                    <t t-esc="zeiten_map.get(ts.id).get('end_wib')"/>
                                                                </t>
                                                                <t t-else="">
                                                                    <span class="badge bg-success">RUNNING</span>
                                                                </t>
                                                            </td>
                                                            <td>
                                                                <span t-field="ts.employee_id.name"/>
                                                            </td>
                                                            <td>
                                                                <span t-field="ts.name"/>
                                                            </td>
                                                            <td>
                                                                <t t-set="mins"
                                                                   t-value="int(round((ts.unit_amount or 0)*60))"/>
                                                                <t t-set="hh" t-value="mins//60"/>
                                                                <t t-set="mm" t-value="mins%60"/>
                                                                <span>
                                                                    <t t-esc="'%02d:%02d' % (hh, mm)"/>
                                                                    <small class="text-muted d-block">(<t
                                                                            t-esc="round(ts.unit_amount or 0,2)"/>h)
                                                                    </small>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <span t-if="ts.z_state=='approved'"
                                                                      class="badge bg-success">Done
                                                                </span>
                                                                <span t-elif="ts.z_state=='waiting_approval'"
                                                                      class="badge bg-warning text-dark">Waiting
                                                                </span>
                                                                <span t-elif="ts.z_state=='draft'"
                                                                      class="badge bg-secondary">Draft
                                                                </span>
                                                                <span t-else="" class="badge bg-light text-dark">
                                                                    <t t-esc="ts.z_state"/>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <t t-if="task.z_project_task_state not in ('approved1','approved2','done')">
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-outline-primary edit-timesheet-btn"
                                                                            t-att-data-task-id="task.id"
                                                                            t-att-data-timesheet-id="ts.id">
                                                                        <i class="fa fa-edit"></i>
                                                                    </button>
                                                                    <form t-attf-action="/portal/task/#{task.id}/timesheet/delete/#{ts.id}"
                                                                          method="post" class="d-inline-block ms-1"
                                                                          t-if="can_approve_timesheet_for_task or can_approve_timesheet">
                                                                        <input type="hidden" name="csrf_token"
                                                                               t-att-value="request.csrf_token()"/>
                                                                        <button type="submit"
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="return confirm('Delete?')">
                                                                            <i class="fa fa-trash"></i>
                                                                        </button>
                                                                    </form>
                                                                </t>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                        <t t-if="ts_pager and ts_pager['total_pages'] &gt; 1">
                                            <div class="load-more-wrapper">
                                                <button class="btn btn-outline-primary btn-sm btn-load-more-timesheets"
                                                        t-att-data-task-id="task.id"
                                                        data-next-page="2">Load More
                                                </button>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-if="not (timesheets_show or timesheets)">
                                        <div class="alert alert-warning" role="alert">No timesheet entries.</div>
                                    </t>
                                </div>

                                <!-- ========== TIMESHEET CARDS (Mobile) ========== -->
                                <div class="d-md-none mt-4">
                                    <t t-if="timesheets_show or timesheets">
                                        <div class="row g-3" id="timesheet_card_container">
                                            <t t-foreach="timesheets_show or timesheets" t-as="ts">
                                                <div class="col-12">
                                                    <div class="card shadow-sm">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                                <h6 class="card-title mb-0">
                                                                    <span t-field="ts.employee_id.name"/>
                                                                </h6>
                                                                <span t-if="ts.z_state=='approved'"
                                                                      class="badge bg-success">Approved
                                                                </span>
                                                                <span t-elif="ts.z_state=='waiting_approval'"
                                                                      class="badge bg-warning text-dark">Waiting
                                                                </span>
                                                                <span t-elif="ts.z_state=='draft'"
                                                                      class="badge bg-secondary">Draft
                                                                </span>
                                                                <span t-else="" class="badge bg-light text-dark">
                                                                    <t t-esc="ts.z_state"/>
                                                                </span>
                                                            </div>
                                                            <div class="row g-2 text-sm">
                                                                <div class="col-6">
                                                                    <strong>Start:</strong>
                                                                    <br/>
                                                                    <t t-if="zeiten_map.get(ts.id)">
                                                                        <span t-esc="zeiten_map.get(ts.id).get('start_wib')"/>
                                                                    </t>
                                                                </div>
                                                                <div class="col-6">
                                                                    <strong>End:</strong>
                                                                    <br/>
                                                                    <t t-if="zeiten_map.get(ts.id) and zeiten_map.get(ts.id).get('end_wib')">
                                                                        <span t-esc="zeiten_map.get(ts.id).get('end_wib')"/>
                                                                    </t>
                                                                    <t t-else="">
                                                                        <span class="text-muted">Running...</span>
                                                                    </t>
                                                                </div>
                                                            </div>
                                                            <div class="mt-2">
                                                                <strong>Duration:</strong>
                                                                <t t-set="mins"
                                                                   t-value="int(round((ts.unit_amount or 0)*60))"/>
                                                                <t t-set="hh" t-value="mins//60"/>
                                                                <t t-set="mm" t-value="mins%60"/>
                                                                <span>
                                                                    <t t-esc="'%02d:%02d' % (hh, mm)"/>
                                                                    <small class="text-muted d-block">(<t
                                                                            t-esc="round(ts.unit_amount or 0,2)"/>h)
                                                                    </small>
                                                                </span>
                                                            </div>
                                                            <t t-if="ts.name">
                                                                <div class="mt-2">
                                                                    <strong>Description:</strong>
                                                                    <br/>
                                                                    <span t-field="ts.name" class="text-muted"/>
                                                                </div>
                                                            </t>
                                                            <div class="mt-3 d-flex gap-2">
                                                                <t t-if="task.z_project_task_state not in ('approved1','approved2','done')">
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-outline-primary edit-timesheet-btn"
                                                                            t-att-data-task-id="task.id"
                                                                            t-att-data-timesheet-id="ts.id">
                                                                        <i class="fa fa-edit"></i>
                                                                    </button>
                                                                    <form t-if="can_approve_timesheet_for_task or can_approve_timesheet"
                                                                          t-attf-action="/portal/task/#{task.id}/timesheet/delete/#{ts.id}"
                                                                          method="post" class="d-inline-block">
                                                                        <input type="hidden" name="csrf_token"
                                                                               t-att-value="request.csrf_token()"/>
                                                                        <button type="submit"
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="return confirm('Delete?')">
                                                                            <i class="fa fa-trash"></i>
                                                                        </button>
                                                                    </form>
                                                                </t>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                        <t t-if="ts_pager and ts_pager['total_pages'] &gt; 1">
                                            <div class="load-more-wrapper">
                                                <button class="btn btn-outline-primary btn-sm btn-load-more-timesheets"
                                                        t-att-data-task-id="task.id"
                                                        data-next-page="2">Load More
                                                </button>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-if="not (timesheets_show or timesheets)">
                                        <div class="alert alert-warning" role="alert">
                                            <i class="fa fa-info-circle me-2"></i>No timesheet entries yet.
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <!-- Subtasks -->
                        <div class="tab-pane fade" id="subtasks" t-if="is_pm or is_head_engineer">
                            <div class="mt-3 mb-3">
                                <t t-if="subtasks">
                                    <div class="table-responsive d-none d-md-block">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Master</th>
                                                    <th>Heads</th>
                                                    <th>Members</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="subtasks" t-as="st">
                                                    <tr>
                                                        <td>
                                                            <t t-esc="st.name"/>
                                                        </td>
                                                        <td>
                                                            <!--                                                            <t t-esc="st.z_master_task_id.z_name if st.z_master_task_id else ''"/>-->
                                                            <t t-esc="st.z_display_master_task or ''"/>

                                                        </td>
                                                        <td>
                                                            <t t-foreach="st.z_head_assignes_ids" t-as="h">
                                                                <span class="badge bg-info me-1">
                                                                    <t t-esc="h.name"/>
                                                                </span>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-foreach="st.z_member_assignes_ids" t-as="m">
                                                                <span class="badge bg-secondary me-1">
                                                                    <t t-esc="m.name"/>
                                                                </span>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-set="status_dict"
                                                               t-value="dict(st._fields['z_project_task_state'].selection)"/>
                                                            <span class="badge"
                                                                  t-att-class="st.z_project_task_state == 'done' and 'bg-success' or (st.z_project_task_state == 'in_progress' and 'bg-primary') or (st.z_project_task_state == 'cancel' and 'bg-danger') or 'bg-light text-dark'">
                                                                <t t-esc="status_dict.get(st.z_project_task_state)"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-md-none">
                                        <div class="row g-3">
                                            <t t-foreach="subtasks" t-as="st">
                                                <div class="col-12">
                                                    <div class="card shadow-sm">
                                                        <div class="card-body p-3">
                                                            <h6 class="mb-1">
                                                                <t t-esc="st.name"/>
                                                            </h6>
                                                            <t t-set="status_dict"
                                                               t-value="dict(st._fields['z_project_task_state'].selection)"/>
                                                            <div class="mb-2">
                                                                <span class="badge"
                                                                      t-att-class="st.z_project_task_state == 'done' and 'bg-success' or (st.z_project_task_state == 'in_progress' and 'bg-primary') or (st.z_project_task_state == 'cancel' and 'bg-danger') or 'bg-light text-dark'">
                                                                    <t t-esc="status_dict.get(st.z_project_task_state)"/>
                                                                </span>
                                                            </div>
                                                            <t t-if="st.z_master_task_id">
                                                                <div class="mb-2">
                                                                    <strong>Master Task:</strong>
                                                                    <br/>
                                                                    <span class="text-muted">
                                                                        <t t-esc="st.z_master_task_id.z_name"/>
                                                                    </span>
                                                                </div>
                                                            </t>
                                                            <t t-if="st.z_head_assignes_ids">
                                                                <div class="mb-2">
                                                                    <strong>Head Assignees:</strong>
                                                                    <br/>
                                                                    <t t-foreach="st.z_head_assignes_ids" t-as="h">
                                                                        <span class="badge bg-info me-1">
                                                                            <t t-esc="h.name"/>
                                                                        </span>
                                                                    </t>
                                                                </div>
                                                            </t>
                                                            <t t-if="st.z_member_assignes_ids">
                                                                <div class="mb-2">
                                                                    <strong>Members:</strong>
                                                                    <br/>
                                                                    <t t-foreach="st.z_member_assignes_ids" t-as="m">
                                                                        <span class="badge bg-secondary me-1">
                                                                            <t t-esc="m.name"/>
                                                                        </span>
                                                                    </t>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </t>
                                <t t-else="">
                                    <div class="alert alert-info">No subtasks.</div>
                                </t>
                            </div>
                        </div>

                        <!-- Invoice Plan -->
                        <div class="tab-pane fade" id="invoice-plan"
                             t-if="(is_pm or is_head_engineer or is_support) and not is_engineer">
                            <div class="mt-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">Invoice Plan</h5>
                                    <button type="button" class="btn btn-primary add-invoice-plan-btn"
                                            t-if="can_edit_invoice_plan"
                                            t-att-data-task-id="task.id">
                                        <i class="fa fa-plus me-1"></i>Add
                                    </button>
                                </div>
                                <t t-if="invoice_plans_show or task.z_invoice_plan_ids">
                                    <div class="table-responsive d-none d-md-block">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>No.</th>
                                                    <th>Description</th>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th t-if="can_edit_invoice_plan">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoice_plan_table_body">
                                                <t t-foreach="invoice_plans_show or task.z_invoice_plan_ids" t-as="inv">
                                                    <tr>
                                                        <td>
                                                            <t t-esc="inv.z_number_of_invoice"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="inv.z_name"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="inv.z_invoice_date.strftime('%d/%m/%Y') if inv.z_invoice_date else ''"/>
                                                        </td>
                                                        <td>Rp
                                                            <t t-esc="'{:,.2f}'.format(inv.z_amount_total)"/>
                                                        </td>
                                                        <td>
                                                            <span t-att-class="'badge ' + ('bg-success' if inv.z_state=='paid' else 'bg-warning' if inv.z_state=='sent' else 'bg-secondary')">
                                                                <t t-esc="inv.z_state.title()"/>
                                                            </span>
                                                        </td>
                                                        <td t-if="can_edit_invoice_plan">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-primary edit-invoice-plan-btn"
                                                                    t-att-data-task-id="task.id"
                                                                    t-att-data-invoice-id="inv.id">
                                                                <i class="fa fa-edit"></i>
                                                            </button>
                                                            <form t-attf-action="/portal/task/#{task.id}/invoice-plan/delete/#{inv.id}"
                                                                  method="post" class="d-inline-block ms-1">
                                                                <input type="hidden" name="csrf_token"
                                                                       t-att-value="request.csrf_token()"/>
                                                                <button type="submit"
                                                                        class="btn btn-sm btn-outline-danger"
                                                                        onclick="return confirm('Delete invoice plan?')">
                                                                    <i class="fa fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Mobile -->
                                    <div class="d-md-none">
                                        <div class="row g-3" id="invoice_plan_card_container">
                                            <t t-foreach="invoice_plans_show or task.z_invoice_plan_ids" t-as="inv">
                                                <div class="col-12">
                                                    <div class="card shadow-sm">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex justify-content-between">
                                                                <strong>
                                                                    <t t-esc="inv.z_number_of_invoice"/>
                                                                </strong>
                                                                <span t-att-class="'badge ' + ('bg-success' if inv.z_state=='paid' else 'bg-warning' if inv.z_state=='sent' else 'bg-secondary')">
                                                                    <t t-esc="inv.z_state.title()"/>
                                                                </span>
                                                            </div>
                                                            <div class="small text-muted mb-1">
                                                                <t t-esc="inv.z_invoice_date.strftime('%d/%m/%Y') if inv.z_invoice_date else ''"/>
                                                            </div>
                                                            <div>
                                                                <t t-esc="inv.z_name"/>
                                                            </div>
                                                            <div class="mt-1">
                                                                <strong>Amount:</strong>
                                                                Rp
                                                                <t t-esc="'{:,.2f}'.format(inv.z_amount_total)"/>
                                                            </div>
                                                            <t t-if="can_edit_invoice_plan">
                                                                <div class="mt-2 d-flex gap-2">
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-outline-primary edit-invoice-plan-btn"
                                                                            t-att-data-task-id="task.id"
                                                                            t-att-data-invoice-id="inv.id">
                                                                        <i class="fa fa-edit"></i>
                                                                    </button>
                                                                    <form t-attf-action="/portal/task/#{task.id}/invoice-plan/delete/#{inv.id}"
                                                                          method="post" class="d-inline-block">
                                                                        <input type="hidden" name="csrf_token"
                                                                               t-att-value="request.csrf_token()"/>
                                                                        <button type="submit"
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="return confirm('Delete invoice plan?')">
                                                                            <i class="fa fa-trash"></i>
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>

                                    <t t-if="ip_pager and ip_pager['total_pages'] &gt; 1">
                                        <div class="load-more-wrapper">
                                            <button class="btn btn-outline-primary btn-sm btn-load-more-invoice-plans"
                                                    t-att-data-task-id="task.id"
                                                    data-next-page="2">Load More
                                            </button>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="alert alert-info">No invoice plans.</div>
                                </t>
                            </div>
                        </div>

                        <!-- Chatter -->
                        <div class="mt-4">
                            <hr/>
                            <div id="task_chatter" data-anchor="true">
                                <h3>Communication history</h3>
                                <t t-set="object" t-value="task"/>
                                <t t-set="token" t-value="task.access_token"/>
                                <t t-call="portal.message_thread"/>
                            </div>
                        </div>
                    </div>
                </form>
            </t>

            <!-- ================== LIST MODE ================== -->
            <t t-if="not kw.get('mode') and not task">
                <div class="o_portal_tasks_header row mb-4 d-flex align-items-center">
                    <div class="col-12 d-flex align-items-center">
                        <t t-if="parent_id and parent_task">
                            <a t-attf-href="/portal/task/#{parent_task.id}?mode=edit"
                               class="btn btn-primary d-flex align-items-center me-2">
                                <i class="fa fa-chevron-left me-1"/>Back
                            </a>
                        </t>
                        <t t-if="can_create_task">
                            <a t-if="parent_id"
                               t-attf-href="/portal/tasks?mode=new&amp;parent_id=#{parent_id}"
                               class="btn btn-primary me-2">New Subtask
                            </a>
                            <a t-if="not parent_id"
                               t-attf-href="/portal/tasks?mode=new#{('&amp;project_id=' + str(project_id)) if project_id else ''}"
                               class="btn btn-primary me-2">New Task
                            </a>
                            <!-- Hapus tombol New Others Task -->
                        </t>
                        <t t-elif="project_id and project and show_back_to_project_link">
                            <a t-attf-href="/portal/projects/#{project.id}?view_type=form"
                               class="btn btn-primary d-flex align-items-center me-2">
                                <i class="fa fa-chevron-left me-1"/>Back to Project
                            </a>
                        </t>

                        <h3 class="mb-0">
                            <t t-esc="page_name"/>
                        </h3>
                    </div>
                </div>


                <!-- Search / Sort / Group -->
                <div class="row align-items-center mb-4">
                    <div class="col-lg-4 col-md-12 mb-2 mb-lg-0">
                        <form t-att-action="'/portal/tasks' + ('/parent/' + str(parent_id) if parent_id else '')"
                              method="get" class="d-flex w-100">
                            <input type="hidden" name="sortby" t-att-value="sortby or ''"/>
                            <input type="hidden" name="groupby" t-att-value="groupby or ''"/>
                            <input type="hidden" name="parent_id" t-att-value="parent_id or ''"/>
                            <input type="hidden" name="project_id" t-att-value="project_id or ''"/>
                            <div class="input-group">
                                <input type="text" name="search" class="form-control" t-att-value="search or ''"
                                       placeholder="Search tasks..."/>
                                <button class="btn btn-primary" type="submit">
                                    <i class="fa fa-search"/>
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="col-lg-8 col-md-12 d-flex flex-wrap justify-content-start justify-content-lg-end align-items-center">
                        <div class="dropdown me-2 mb-2 mb-lg-0">
                            <a class="btn btn-primary dropdown-toggle" href="#" data-bs-toggle="dropdown">Options</a>
                            <ul class="dropdown-menu">
                                <li class="dropdown-header">Sort By</li>
                                <li t-foreach="searchbar_sortings" t-as="skey">
                                    <a role="menuitem"
                                       t-attf-class="dropdown-item #{'active' if skey == sortby else ''}"
                                       t-att-href="'/portal/tasks?sortby=%s&amp;search=%s&amp;groupby=%s%s%s' % (skey, (search or ''), (groupby or ''), parent_id and ('&amp;parent_id='+str(parent_id)) or '', project_id and ('&amp;project_id='+str(project_id)) or '')">
                                        <t t-esc="searchbar_sortings[skey]['label']"/>
                                    </a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider"/>
                                </li>
                                <li class="dropdown-header">Group By</li>
                                <li t-foreach="searchbar_groupings" t-as="gkey">
                                    <a role="menuitem"
                                       t-attf-class="dropdown-item #{'active' if gkey == groupby else ''}"
                                       t-att-href="'/portal/tasks?sortby=%s&amp;search=%s&amp;groupby=%s%s%s' % ((sortby or ''), (search or ''), (gkey or ''), parent_id and ('&amp;parent_id='+str(parent_id)) or '', project_id and ('&amp;project_id='+str(project_id)) or '')">
                                        <t t-esc="searchbar_groupings[gkey]['label']"/>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="d-flex flex-grow-1 justify-content-end">
                            <t t-if="pager_header and not groupby">
                                <t t-call="portal.pager">
                                    <t t-set="pager" t-value="pager_header"/>
                                </t>
                            </t>
                        </div>
                    </div>
                </div>

                <hr/>

                <!-- Task Table -->
                <t t-if="tasks">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle task-list-table"
                               style="table-layout:fixed;">
                            <thead>
                                <tr>
                                    <th style="width:150px;">Task Code</th>
                                    <th style="width:160px;">Name of Task</th>
                                    <th style="width:160px;">Name of Project</th>
                                    <th style="width:110px;">Project</th>
                                    <th style="width:110px;">Customer</th>
                                    <th style="width:90px;">Status</th>
                                    <th class="w-head">Head(s)</th>
                                    <th class="w-member">Member(s)</th>
                                    <th style="width:100px;">Tech</th>
                                    <th style="width:90px;">Severity</th>
                                    <th style="width:120px;">Planned</th>
                                    <th t-if="show_metrics" style="width:70px;">Bobot</th>
                                    <th t-if="show_metrics" style="width:90px;">Progress</th>
                                    <th style="width:48px;"/>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- GROUPED -->
                                <t t-if="groupby">
                                    <t t-foreach="tasks" t-as="grp">
                                        <!-- Header grup -->
                                        <tr class="table-group-header-row">
                                            <td style="width:150px;">
                                                <button class="group-toggle-btn" type="button"
                                                        t-att-data-group-id="'grp_'+str(grp.get('group_index'))">
                                                    <i class="fa fa-caret-right"></i>
                                                </button>
                                                <span t-esc="grp.get('group_value')"/>
                                                (<t t-esc="grp.get('pager').get('total')"/>)

                                                <!-- Pager per group -->
                                                <t t-set="pg" t-value="grp.get('pager')"/>
                                                <t t-if="pg and pg.get('total') &gt; pg.get('step')">
                                                    <nav aria-label="group pager" class="d-inline-block ms-2">
                                                        <ul class="pagination pagination-sm mb-0">
                                                            <t t-foreach="pg.get('pages')" t-as="p">
                                                                <li t-att-class="'page-item %s' % ('active' if p == pg.get('page') else '')">
                                                                    <a class="page-link"
                                                                       t-att-href="request.httprequest.path + '?' + (common_query and (common_query + '&amp;') or '') + pg.get('page_param') + '=' + str(p)">
                                                                        <t t-esc="p"/>
                                                                    </a>
                                                                </li>
                                                            </t>
                                                        </ul>
                                                    </nav>
                                                </t>
                                            </td>
                                            <!-- Sisa kolom dikosongkan agar header grup sejajar dengan header tabel -->
                                            <td t-att-colspan="(show_metrics and 13) or 11"></td>
                                        </tr>

                                        <!-- Baris item (sejajar dengan header utama), disembunyikan default -->
                                        <t t-foreach="grp.get('tasks')" t-as="tk">
                                            <tr class="group-item-row"
                                                t-att-data-group="'grp_'+str(grp.get('group_index'))"
                                                style="display:none; cursor:pointer;"
                                                t-attf-onclick="window.location.href='/portal/task/#{tk.id}?mode=edit'">

                                                <!-- Task Code + Running (teks) -->
                                                <td>
                                                    <t t-set="depth" t-value="depth_map.get(tk.id,0)"/>
                                                    <span t-att-style="'padding-left:%spx' % (depth*14)">
                                                        <t t-if="depth">↳</t>
                                                        <span t-esc="tk.name"/>
                                                    </span>
                                                    <t t-if="running_task_ids and tk.id in running_task_ids">
                                                        <span class="badge badge-running ms-1">Running</span>
                                                    </t>
                                                </td>

                                                <!-- Name of Task -->
                                                <td>
                                                    <span class="ellipsis" t-esc="tk.z_display_master_task or ''"/>
                                                </td>

                                                <!-- Name of Project -->
                                                <td class="clip"
                                                    t-att-title="(tk.project_id and (tk.project_id.label_tasks or tk.project_id.name)) or ''">
                                                    <span class="ellipsis"
                                                          t-esc="tk.project_id and (tk.project_id.label_tasks or tk.project_id.name) or ''"/>
                                                </td>

                                                <!-- Project -->
                                                <td class="clip"
                                                    t-att-title="tk.project_id and tk.project_id.name or ''">
                                                    <span class="ellipsis"
                                                          t-esc="tk.project_id and tk.project_id.name or ''"/>
                                                </td>

                                                <!-- Customer -->
                                                <td class="clip"
                                                    t-att-title="tk.partner_id and tk.partner_id.name or ''">
                                                    <span class="ellipsis"
                                                          t-esc="tk.partner_id and tk.partner_id.name or ''"/>
                                                </td>

                                                <!-- Status: teks biasa -->
                                                <td>
                                                    <t t-set="status_dict"
                                                       t-value="dict(tk._fields['z_project_task_state'].selection)"/>
                                                    <span t-esc="status_dict.get(tk.z_project_task_state) or ''"/>
                                                </td>

                                                <!-- Heads: teks dipisah koma -->
                                                <td>
                                                    <span t-esc="', '.join(tk.z_head_assignes_ids.mapped('name'))"/>
                                                </td>

                                                <!-- Members: teks dipisah koma -->
                                                <td>
                                                    <span t-esc="', '.join(tk.z_member_assignes_ids.mapped('name'))"/>
                                                </td>

                                                <!-- Tech -->
                                                <td>
                                                    <span t-esc="tk.z_technology_id and tk.z_technology_id.z_name or ''"/>
                                                </td>

                                                <!-- Severity -->
                                                <td>
                                                    <span t-esc="tk.z_severity_id and tk.z_severity_id.z_name or ''"/>
                                                </td>

                                                <!-- Planned -->
                                                <td>
                                                    <span t-esc="tk.z_planned_start_date or ''"/>
                                                    <t t-if="tk.z_planned_start_date and tk.z_planned_end_date">→</t>
                                                    <span t-esc="tk.z_planned_end_date or ''"/>
                                                </td>

                                                <!-- Bobot 2 desimal -->
                                                <td t-if="show_metrics">
                                                    <t t-esc="'{:.2f}'.format(tk.z_bobot_entry or 0.0)"/>
                                                </td>

                                                <!-- Progress -->
                                                <td t-if="show_metrics">
                                                    <t t-esc="tk.z_progress_project or 0.0"/>
                                                </td>

                                                <!-- Action -->
                                                <td onclick="event.stopPropagation();">
                                                    <form t-if="can_delete_task"
                                                          t-attf-action="/portal/tasks/delete/#{tk.id}" method="post"
                                                          class="d-inline-block">
                                                        <input type="hidden" name="csrf_token"
                                                               t-att-value="request.csrf_token()"/>
                                                        <button type="submit" class="btn btn-link p-0"
                                                                onclick="return confirm('Delete?')">
                                                            <i class="fa fa-trash text-danger"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                        </t>
                                    </t>
                                </t>

                                <!-- FLAT -->
                                <t t-if="not groupby">
                                    <t t-foreach="tasks" t-as="tk">
                                        <tr style="cursor:pointer;"
                                            t-attf-onclick="window.location.href='/portal/task/#{tk.id}?mode=edit'">
                                            <td>
                                                <t t-set="depth" t-value="depth_map.get(tk.id,0)"/>
                                                <span t-att-style="'padding-left:%spx' % (depth*14)">
                                                    <t t-if="depth">↳</t>
                                                    <span t-esc="tk.name"/>
                                                </span>
                                                <t t-if="running_task_ids and tk.id in running_task_ids">
                                                    <span class="badge badge-running ms-1">Running</span>
                                                </t>
                                            </td>
                                            <td>
                                                <span class="ellipsis" t-esc="tk.z_display_master_task or ''"/>

                                            </td>
                                            <!-- Name of Project -->
                                            <td class="clip"
                                                t-att-title="(tk.project_id and (tk.project_id.label_tasks or tk.project_id.name)) or ''">
                                                <span class="ellipsis"
                                                      t-esc="tk.project_id and (tk.project_id.label_tasks or tk.project_id.name) or ''"/>
                                            </td>

                                            <!-- Project -->
                                            <td class="clip" t-att-title="tk.project_id and tk.project_id.name or ''">
                                                <span class="ellipsis"
                                                      t-esc="tk.project_id and tk.project_id.name or ''"/>
                                            </td>

                                            <!-- Customer -->
                                            <td class="clip" t-att-title="tk.partner_id and tk.partner_id.name or ''">
                                                <span class="ellipsis"
                                                      t-esc="tk.partner_id and tk.partner_id.name or ''"/>
                                            </td>
                                            <!-- Status: teks biasa -->
                                            <td>
                                                <t t-set="status_dict"
                                                   t-value="dict(tk._fields['z_project_task_state'].selection)"/>
                                                <span t-esc="status_dict.get(tk.z_project_task_state) or ''"/>
                                            </td>
                                            <!-- Heads: teks -->
                                            <td>
                                                <span t-esc="', '.join(tk.z_head_assignes_ids.mapped('name'))"/>
                                            </td>
                                            <!-- Members: teks -->
                                            <td>
                                                <span t-esc="', '.join(tk.z_member_assignes_ids.mapped('name'))"/>
                                            </td>
                                            <td>
                                                <span t-esc="tk.z_technology_id and tk.z_technology_id.z_name or ''"/>
                                            </td>
                                            <td>
                                                <span t-esc="tk.z_severity_id and tk.z_severity_id.z_name or ''"/>
                                            </td>
                                            <td>
                                                <span t-esc="tk.z_planned_start_date or ''"/>
                                                <t t-if="tk.z_planned_start_date and tk.z_planned_end_date">→</t>
                                                <span t-esc="tk.z_planned_end_date or ''"/>
                                            </td>
                                            <!-- Bobot: 2 desimal -->
                                            <td t-if="show_metrics">
                                                <t t-esc="'{:.2f}'.format(tk.z_bobot_entry or 0.0)"/>
                                            </td>
                                            <td t-if="show_metrics">
                                                <t t-esc="tk.z_progress_project or 0.0"/>
                                            </td>
                                            <td onclick="event.stopPropagation();">
                                                <form t-if="can_delete_task"
                                                      t-attf-action="/portal/tasks/delete/#{tk.id}" method="post"
                                                      class="d-inline-block">
                                                    <input type="hidden" name="csrf_token"
                                                           t-att-value="request.csrf_token()"/>
                                                    <button type="submit" class="btn btn-link p-0"
                                                            onclick="return confirm('Delete?')">
                                                        <i class="fa fa-trash text-danger"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
                <t t-if="not tasks">
                    <div class="alert alert-warning" role="alert">
                        <img src="/web/static/img/folder.svg"/>
                        <span t-if="parent_id">There are no subtasks for this parent task.</span>
                        <span t-if="not parent_id">There are no tasks.</span>
                    </div>
                </t>
            </t>

            <!-- ================== MODALS ================== -->

            <!-- Request Timesheet Modal -->
            <div class="modal fade" id="requestTimesheetModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fa fa-clock-o me-2"></i>Request Timesheet (New Entry)
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                        </div>
                        <div class="modal-body">
                            <form id="requestTimesheetForm">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="text" name="start_date" class="form-control dt-24"
                                           required="required"/>

                                </div>
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="text" name="end_date" class="form-control dt-24" required="required"/>
                                    <div class="form-text" id="request_hours_hint"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea name="description" class="form-control" rows="3" required="required"
                                              placeholder="Describe your activity..."></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Employee</small>
                                        <strong>
                                            <t t-esc="request.env['hr.employee'].sudo().search([('user_id','=',request.env.user.id)], limit=1).name or request.env.user.name"/>
                                        </strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Company</small>
                                        <strong>
                                            <t t-esc="request.env.user.company_id.name"/>
                                        </strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Project</small>
                                        <strong>
                                            <t t-esc="task.project_id.name if task else ''"/>
                                        </strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Task</small>
                                        <strong>
                                            <t t-esc="task.name if task else ''"/>
                                        </strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Name of Project</small>
                                        <strong>
                                            <t t-esc="task.project_id.label_tasks or task.project_id.name if task else ''"/>
                                        </strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Name of Task</small>
                                        <strong>
                                            <t t-esc="task.z_master_task_id.z_name if task and task.z_master_task_id else ''"/>
                                        </strong>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveRequestTimesheetBtn"
                                    t-att-data-task-id="task.id if task else 0">
                                <i class="fa fa-paper-plane me-1"></i>Submit Request
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer Stop Modal -->
            <div class="modal fade" id="timerStopModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fa fa-stop-circle me-2"></i>Stop Timer
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Describe your activity
                                    <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="timerStopDescription" rows="4"
                                          placeholder="What did you accomplish?" required="required"></textarea>
                                <div id="descriptionError" class="invalid-feedback d-none">Description is required when
                                    stopping the timer.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Attachments (optional)</label>
                                <input type="file" class="form-control" id="timerAttachments" multiple="multiple"
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"/>
                                <div class="form-text">You can attach multiple files.</div>
                                <div id="filePreview"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fa fa-times me-1"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-danger" id="confirmStopBtn"
                                    t-att-data-task-id="task.id if task else 0">
                                <i class="fa fa-stop me-1"></i>Stop &amp; Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timesheet Correction Modal -->
            <div class="modal fade" id="timesheetModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="timesheetModalLabel">Timesheet Correction</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                        </div>
                        <div class="modal-body">
                            <form id="timesheetForm">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" id="timesheet_id" name="timesheet_id"/>
                                <input type="hidden" id="current_task_id" value=""/>
                                <input type="hidden" id="timesheet_hours" name="hours"/>

                                <div class="alert alert-secondary py-2 mb-3">
                                    <strong>Original</strong>
                                    <br/>
                                    <strong>Actual (New)</strong>
                                </div>

                                <div class="mb-2">
                                    <label class="form-label">Original Start</label>
                                    <input type="datetime-local" class="form-control" id="timesheet_original_start_date"
                                           readonly="1"/>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Original End</label>
                                    <input type="datetime-local" class="form-control" id="timesheet_original_end_date"
                                           readonly="1"/>
                                </div>
                                <hr/>
                                <div class="mb-2">
                                    <label class="form-label text-primary">Actual Start (New)</label>
                                    <input type="text" class="form-control dt-24" id="timesheet_start_date"
                                           name="start_date" required="1"/>

                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-primary">Actual End (New)</label>
                                    <input type="text" class="form-control dt-24" id="timesheet_end_date"
                                           name="end_date" required="1"/>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description (New)</label>
                                    <textarea class="form-control" id="timesheet_description" name="description"
                                              rows="3" required="1"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Employee</label>
                                    <select class="form-select" id="timesheet_employee" name="employee_id" required="1"
                                            disabled="disabled">
                                        <option value="">Select employee...</option>
                                        <t t-foreach="request.env['hr.employee'].sudo().search([])" t-as="emp">
                                            <option t-att-value="emp.id">
                                                <t t-esc="emp.name"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                <div id="pending_info" class="alert alert-warning py-2 px-3 d-none">
                                    <i class="fa fa-exclamation-triangle me-1"></i>
                                    Pending correction exists.
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button class="btn btn-primary" id="saveTimesheetBtn">
                                <i class="fa fa-paper-plane me-1"></i>Submit Correction
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Plan Modal -->
            <div class="modal fade" id="invoicePlanModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Invoice Plan</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                        </div>
                        <div class="modal-body">
                            <form id="invoicePlanForm">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="invoice_plan_id" id="invoice_plan_id"/>
                                <div class="mb-3">
                                    <label class="form-label">Invoice Number</label>
                                    <input type="text" name="z_number_of_invoice" class="form-control"/>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea name="z_name" rows="2" class="form-control"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Invoice Date</label>
                                    <input type="date" name="z_invoice_date" class="form-control"/>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Amount</label>
                                    <input type="number" step="0.01" name="z_amount_total" class="form-control"/>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select name="z_state" class="form-select">
                                        <option value="draft">Draft</option>
                                        <option value="sent">Sent</option>
                                        <option value="paid">Paid</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                            <button class="btn btn-primary" id="saveInvoicePlanBtn"
                                    t-att-data-task-id="task and task.id">Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </t>
    </template>
</odoo>